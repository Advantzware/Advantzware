        1   /*******************************************************************************
        2    *******************************************************************************
        3    **                                                                           **
        4    **                                                                           **
        5    **  Copyright 2003-2009 Tom Bascom, Greenfield Technologies                  **
        6    **  http://www.greenfieldtech.com                                            **
        7    **                                                                           **
        8    **  ProTop is free software; you can redistribute it and/or modify it        **
        9    **  under the terms of the GNU General Public License (GPL) as published     **
       10    **  by the Free Software Foundation; either version 2 of the License, or     **
       11    **  at your option) any later version.                                       **
       12    **                                                                           **
       13    **  ProTop is distributed in the hope that it will be useful, but WITHOUT    **
       14    **  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or    **
       15    **  FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License     **
       16    **  for more details.                                                        **
       17    **                                                                           **
       18    **  See TERMS.TXT for more information regarding the Terms and Conditions    **
       19    **  of use and alternative licensing options for this software.              **
       20    **                                                                           **
       21    **  A copy of the GPL is in GPL.TXT which was provided with this package.    **
       22    **                                                                           **
       23    **  See http://www.fsf.org for more information about the GPL.               **
       24    **                                                                           **
       25    **                                                                           **
       26    *******************************************************************************
       27    *******************************************************************************
       28    *
       29    * userinfo.p
       30    *
       31    */
       32   
       33   
       34   /*******************************************************************************
       35    *******************************************************************************
       36    **                                                                           **
       37    **                                                                           **
       38    **  Copyright 2003-2006 Tom Bascom, Greenfield Technologies                  **
       39    **  http://www.greenfieldtech.com                                            **
       40    **                                                                           **
       41    **  ProTop is free software; you can redistribute it and/or modify it        **
       42    **  under the terms of the GNU General Public License (GPL) as published     **
       43    **  by the Free Software Foundation; either version 2 of the License, or     **
       44    **  at your option) any later version.                                       **
       45    **                                                                           **
       46    **  ProTop is distributed in the hope that it will be useful, but WITHOUT    **
       47    **  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or    **
       48    **  FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License     **
       49    **  for more details.                                                        **
       50    **                                                                           **
       51    **  See TERMS.TXT for more information regarding the Terms and Conditions    **
       52    **  of use and alternative licensing options for this software.              **
       53    **                                                                           **
       54    **  A copy of the GPL is in GPL.TXT which was provided with this package.    **
       55    **                                                                           **
       56    **  See http://www.fsf.org for more information about the GPL.               **
       57    **                                                                           **
       58    **                                                                           **
       59    *******************************************************************************
       60    *******************************************************************************
       61    *
       62    * protop.i
       63    *
       64    * Header file for protop family of programs
       65    *
       66    *
       67    * Known Bugs & Issues:
       68    *
       69    *
       70    * To Do:
       71    *
       72    *
       73    * Author:
       74    *
       75    *      Tom Bascom, Greenfield Technologies
       76    *      http://www.greenfieldtech.com
       77    *      August 28, 2003
       78    *
       79    */
       80   
       81   &IF DECIMAL(SUBSTRING(PROVERSION,1,INDEX(PROVERSION,".") + 1)) >= 11.4 &THEN
       82   &global-define  FASTLOCK        true
       83   &ELSE
       84   &global-define  FASTLOCK        false
       85   &ENDIF
       86   
       87   &IF DECIMAL(SUBSTRING(PROVERSION,1,INDEX(PROVERSION,".") + 1)) >= 11.0 &THEN
       88   &global-define  OE11            "yes"
       89   &global-define  xDEBUGTT        false
       90   &ENDIF
       91   
       92   &IF DECIMAL(SUBSTRING(PROVERSION,1,INDEX(PROVERSION,".") + 1)) >= 10.2 AND PROVERSION >= "10.2B" &THEN
       93   &global-define  NOSERIALIZE     serialize-hidden
       94   &ENDIF
       95   
       96   &IF DECIMAL(SUBSTRING(PROVERSION,1,INDEX(PROVERSION,".") + 1)) >= 10.1 AND PROVERSION >= "10.1B" &THEN
       97   &global-define  BIGINT          int64
       98   &ELSE
       99   &global-define  BIGINT          decimal
      100   &ENDIF
      101   
      102   
      103   /* lib/v9.i
      104    *
      105    */
      106   
      107   &IF DECIMAL(SUBSTRING(PROVERSION,1,INDEX(PROVERSION,".") + 1)) < 10.0 &THEN
      108   &global-define  CPYLOB  "no"
      109   &global-define  NOW     substitute( "&1 &2", today, string( time, "hh:mm:ss" ))
      110   &global-define  LNGCR   character
      111   &global-define  DTZ     integer
      112   &global-define  BIGINT  decimal
      113   &ELSE
      114   &global-define  OE10    "yes"
      115   &global-define  NOW     now
      116   &global-define  LNGCR   longchar
      117   &global-define  DTZ     datetime-tz
      118   &global-define  BIGINT  int64
      119   &ENDIF
      120    
      121   
      122   /* use extended _connect fields: -client, -cache*
      123    */
      124   
      125   &IF DECIMAL(SUBSTRING(PROVERSION,1,INDEX(PROVERSION,".") + 1)) >= 10.1 AND PROVERSION >= "10.1C" &THEN
      126   &global-define  CONNECTX        "yes"
      127   &ELSE
      128   &global-define  CONNECTX        "no"
      129   &ENDIF
      130   
      131   define stream inStrm.
      132   
      133   define new global shared variable dbgMode as integer no-undo initial 1.
      134   
      135   /* The values for these are defined in etc/protop.cfg and set by lib/protop-cfg.p
      136    *
      137    * someday everyone will have OO and I will replace these with a gsv class
      138    * or something of that ilk
      139    *
      140    */
      141   
      142   define new global shared variable pt_shortname   as character no-undo.
      143   define new global shared variable pt_uniqName    as character no-undo.
      144   define new global shared variable pt_server      as character no-undo.
      145   define new global shared variable pt_resrcType   as character no-undo.
      146   
      147   define new global shared variable pt_tmpdir      as character no-undo initial "/tmp".
      148   define new global shared variable pt_logdir      as character no-undo initial "/tmp".
      149   define new global shared variable pt_rptdir      as character no-undo initial "/tmp".
      150   define new global shared variable pt_logname     as character no-undo initial "&5.&2.&3".
      151   define new global shared variable pt_mailcmd     as character no-undo initial 'mailx "-s &1" '.
      152   
      153   define new global shared variable pt_votrx       as integer   no-undo initial 1800.
      154   define new global shared variable pt_lktbllim    as integer   no-undo initial 0.
      155   define new global shared variable pt_bkupstale   as integer   no-undo initial 26.
      156   define new global shared variable pt_bogomips    as integer   no-undo initial 1000000.
      157   define new global shared variable pt_ioresp      as integer   no-undo initial 100.
      158   define new global shared variable pt_ioFileName  as character no-undo.
      159   define new global shared variable pt_dfCmd       as character no-undo.
      160   
      161   define new global shared variable pt_AICheckInterval   as integer no-undo initial 60.
      162   define new global shared variable pt_PICACheckInterval as integer no-undo initial 60.
      163   define new global shared variable pt_appsrvStuck       as integer no-undo initial 120.
      164   
      165   define new global shared variable pt_bibkupAlert as integer   no-undo.          /* alert on long bi backup phase                */
      166   define new global shared variable pt_bibkupAlarm as integer   no-undo.          /* alarm on long bi backup phase                */
      167   define new global shared variable pt_bibkupPage  as integer   no-undo.          /* page  on long bi backup phase                */
      168   
      169   define new global shared variable pt_bkupAlert   as integer   no-undo.          /* alert on long db backup                      */
      170   define new global shared variable pt_bkupAlarm   as integer   no-undo.          /* alarm on long db backup                      */
      171   define new global shared variable pt_bkupPage    as integer   no-undo.          /* page  on long db backup                      */
      172   
      173   define new global shared variable pt_userLock    as logical   no-undo.          /* enable _userLock  data?                      */
      174   define new global shared variable pt_doZippy     as logical   no-undo.          /* enable "user experience" (aka "zippy")?      */
      175   define new global shared variable pt_useRFUtil   as logical   no-undo.          /* use rfutil to gather after-imaging status?   */
      176   
      177   define new global shared variable pt_updAreaData as integer   no-undo.          /* how often should we report storage area xref details from dbanalys? */
      178   
      179   define new global shared variable pt_zoomTo      as integer no-undo.            /* new zoomed monInt                            */
      180   
      181   define new global shared variable ptDBName     as character no-undo.                    /* the db logical name          */
      182   define new global shared variable rowLimit     as integer   no-undo initial 100.        /* 50?                          */
      183   
      184   /* do-sumSample() manipulates these -- ugly, ugly, ugly... (obsolete?)
      185    * 
      186    */
      187   
      188   define new global shared variable stime as integer no-undo.                     /* start time                           */
      189   define new global shared variable ltime as integer no-undo.                     /* last time                            */
      190   define new global shared variable xtime as integer no-undo.                     /* total time                           */
      191   define new global shared variable itime as integer no-undo.                     /* iteration time                       */
      192   
      193   define new global shared variable chkp-base   as integer no-undo initial ?.     /* cover for the lack of a VST field    */
      194   
      195                                                                                   /* corresponding to base checkpoint#    */
      196   /** Global Shared Temp Table Definitions
      197    **
      198    ** Yup, they're shared.  But this stuff makes no sense across session boundaries anyway.
      199    ** And a shared temp-table is logically the same as a db table so who really cares?
      200    **
      201    **/
      202   
      203   /* cache _File and _Index records so that we don't keep hitting the db to translate
      204    */
      205   
      206   define new global shared temp-table tt_tbl no-undo
      207     field xid      as integer                                             /* _File._File-Num              */
      208     field tstatid  as integer                                             /* _TableStat._TableStat-Id     */
      209     field areaNum  as integer                                             /* _Storage-Object._Area-Number */
      210     field tblPool  as character                                           /* get-bits( _object-attrib, 7, 1 ) = 1 */
      211     field tblname  as character                                           /* _File._File-Name             */
      212     index xid-idx is unique primary xid.
      213   
      214   define new global shared temp-table tt_idx no-undo
      215     field xid      as integer                                             /* _Index._Idx-Num              */
      216     field istatid  as integer                                             /* _IndexStat._IndexStat-Id     */
      217     field idxname  as character                                           /* _Index._Idx-Name             */
      218     field idxnote  as character
      219     field idxRoot  as int64                                           /* _Storage-Object._Object-Root */
      220     field tblnum   as integer                                             /* _File._File-Num              */
      221     field areaNum  as integer                                             /* _Storage-Object._Area-Number */
      222     field idxPool  as character                                           /* get-bits( _object-attrib, 7, 1 ) = 1 */
      223     field tblname  as character                                           /* _File._File-Name             */
      224     index xid-idx is unique primary xid.
      225   
      226   define new global shared temp-table tt_areaExtent no-undo
      227     field areaNum  as integer                                             /* _areaExtent._Area-Number     */
      228     field extNum   as integer                                             /* _areaExtent._Extent-Number   */
      229   
      230     field extSize  as decimal                                             /* _areaExtent._Extent-Size     */
      231     field extType  as integer                                             /* _areaExtent._Extent-Type     */
      232     field extPath  as character                                           /* _areaExtent._Extent-Path     */
      233   
      234     index ae-idx is unique primary areaNum extNum.
      235   
      236   define new global shared temp-table tt_area no-undo
      237     field xid      as integer    format ">>>9"
      238     field SANum    as integer    format ">>>9"        label "#"
      239     field areaPool as character  format "x(2)"        label "BX"
      240   /*field areaStatus-Id as {&BIGINT} format ">>>9"    label "Id" */
      241     field SAName   as character  format "x(30)"       label "Area Name"
      242     field allocGB  as decimal    format ">>>>>9.99"   label "Allocated"
      243     field varGB    as decimal    format ">>>>>9.99"   label "Variable"
      244     field totGB    as decimal    format ">>>>>>9.99"  label "Tot GB"
      245     field hiGB     as decimal    format ">>>>>9.99"   label "Hi Water" serialize-hidden
      246     field freeGB   as decimal    format ">>>>>9.99"   label "Free GB"
      247     field pctAlloc as decimal    format ">>>>>9%"     label "%Alloc"
      248     field pctLastX as decimal    format ">>>>9%"      label "%LastX"
      249   
      250     field blkszkb as integer     format ">>9"         label "BSZ"
      251     field rpb     as integer     format ">>9"         label "RPB"
      252     field clstrsz as integer     format ">>9"         label "CSZ"
      253   
      254     field numTbls as integer     format ">>>>9"       label "#Tbls"
      255     field numIdxs as integer     format ">>>>9"       label "#Idxs"
      256     field numLOBs as integer     format ">>>>9"       label "#LOBs"
      257   
      258     field numExts as integer     format ">>>>9"       label "#Exts"
      259     field hasVar  as logical     format "Yes/No"      label "Var?"
      260   
      261     field xnote   as character   format "x"           label "*"
      262   
      263     field areaMaxPct as decimal  format ">>9.999%"    label "Max%"
      264     field idx3264    as decimal  format ">>9.999%"    label "Bug%"
      265   
      266     index pctAlloc-idx is primary pctAlloc descending
      267     index pctLastX-idx pctLastX pctAlloc descending
      268     index allocGB-idx allocGB descending
      269     index totGB-idx totGB descending
      270     index xid-idx is unique xid
      271     index SANum-idx is unique SANum
      272     index SAName-idx is unique SAName
      273   .
      274   
      275   *** Encrypted Source ***
      276   *** Encrypted Source ***
      277   *** Encrypted Source ***
      278   *** Encrypted Source ***
      279   *** Encrypted Source ***
      280   *** Encrypted Source ***
      281   *** Encrypted Source ***
      282   *** Encrypted Source ***
      283   *** Encrypted Source ***
      284   *** Encrypted Source ***
      285   *** Encrypted Source ***
      286   *** Encrypted Source ***
      287   *** Encrypted Source ***
      288   *** Encrypted Source ***
      289   *** Encrypted Source ***
      290   *** Encrypted Source ***
      291   *** Encrypted Source ***
      292   *** Encrypted Source ***
      293   *** Encrypted Source ***
      294   *** Encrypted Source ***
      295   *** Encrypted Source ***
      296   *** Encrypted Source ***
      297   *** Encrypted Source ***
      298   *** Encrypted Source ***
      299   *** Encrypted Source ***
      300   *** Encrypted Source ***
      301   *** Encrypted Source ***
      302   *** Encrypted Source ***
      303   *** Encrypted Source ***
      304   *** Encrypted Source ***
      305   *** Encrypted Source ***
      306   *** Encrypted Source ***
      307   *** Encrypted Source ***
      308   *** Encrypted Source ***
      309   *** Encrypted Source ***
      310   *** Encrypted Source ***
      311   *** Encrypted Source ***
      312   *** Encrypted Source ***
      313   *** Encrypted Source ***
      314   *** Encrypted Source ***
      315   *** Encrypted Source ***
      316   *** Encrypted Source ***
      317   *** Encrypted Source ***
      318   *** Encrypted Source ***
      319   *** Encrypted Source ***
      320   *** Encrypted Source ***
      321   *** Encrypted Source ***
      322   *** Encrypted Source ***
      323   *** Encrypted Source ***
      324   *** Encrypted Source ***
      325   *** Encrypted Source ***
      326   *** Encrypted Source ***
      327   *** Encrypted Source ***
      328   *** Encrypted Source ***
      329   *** Encrypted Source ***
      330   *** Encrypted Source ***
      331   *** Encrypted Source ***
      332   *** Encrypted Source ***
      333   *** Encrypted Source ***
      334   *** Encrypted Source ***
      335   *** Encrypted Source ***
      336   *** Encrypted Source ***
      337   *** Encrypted Source ***
      338   *** Encrypted Source ***
      339   *** Encrypted Source ***
      340   *** Encrypted Source ***
      341   *** Encrypted Source ***
      342   *** Encrypted Source ***
      343   *** Encrypted Source ***
      344   *** Encrypted Source ***
      345    
      346   
      347   /*******************************************************************************
      348    *******************************************************************************
      349    **                                                                           **
      350    **                                                                           **
      351    **  Copyright 2003-2006 Tom Bascom, Greenfield Technologies                  **
      352    **  http://www.greenfieldtech.com                                            **
      353    **                                                                           **
      354    **  ProTop is free software; you can redistribute it and/or modify it        **
      355    **  under the terms of the GNU General Public License (GPL) as published     **
      356    **  by the Free Software Foundation; either version 2 of the License, or     **
      357    **  at your option) any later version.                                       **
      358    **                                                                           **
      359    **  ProTop is distributed in the hope that it will be useful, but WITHOUT    **
      360    **  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or    **
      361    **  FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License     **
      362    **  for more details.                                                        **
      363    **                                                                           **
      364    **  See TERMS.TXT for more information regarding the Terms and Conditions    **
      365    **  of use and alternative licensing options for this software.              **
      366    **                                                                           **
      367    **  A copy of the GPL is in GPL.TXT which was provided with this package.    **
      368    **                                                                           **
      369    **  See http://www.fsf.org for more information about the GPL.               **
      370    **                                                                           **
      371    **                                                                           **
      372    *******************************************************************************
      373    *******************************************************************************
      374    *
      375    * protoplib.i
      376    *
      377    * ProTop infrastructure library definitions
      378    *
      379    */
      380   
      381   function uDateTime returns integer () in super.
      382   function string2uDateTime returns integer( input p_text as character ) in super.
      383   function searchDir returns character ( input xDir as character ) in super.
      384   function unsignMe returns decimal ( input s as decimal, input i as integer ) in super.
      385   function hr returns decimal ( input lr as decimal, input osr as decimal, output hr-str as character, output hr as decimal, output mr as decimal ) in super.
      386   function do-SumSample returns logical ( output p_index as integer, output p_time  as integer ) in super.
      387   function myPID returns character () in super.
      388   function hilite returns logical ( input b as handle, input p_metric as character, input p_value as character, output p_attr as character ) in super.
      389   
      390   /* end protoplib.i */
      391    
      392   
      393   /*******************************************************************************
      394    *******************************************************************************
      395    **                                                                           **
      396    **                                                                           **
      397    **  Copyright 2003-2006 Tom Bascom, Greenfield Technologies                  **
      398    **  http://www.greenfieldtech.com                                            **
      399    **                                                                           **
      400    **  ProTop is free software; you can redistribute it and/or modify it        **
      401    **  under the terms of the GNU General Public License (GPL) as published     **
      402    **  by the Free Software Foundation; either version 2 of the License, or     **
      403    **  at your option) any later version.                                       **
      404    **                                                                           **
      405    **  ProTop is distributed in the hope that it will be useful, but WITHOUT    **
      406    **  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or    **
      407    **  FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License     **
      408    **  for more details.                                                        **
      409    **                                                                           **
      410    **  See TERMS.TXT for more information regarding the Terms and Conditions    **
      411    **  of use and alternative licensing options for this software.              **
      412    **                                                                           **
      413    **  A copy of the GPL is in GPL.TXT which was provided with this package.    **
      414    **                                                                           **
      415    **  See http://www.fsf.org for more information about the GPL.               **
      416    **                                                                           **
      417    **                                                                           **
      418    *******************************************************************************
      419    *******************************************************************************
      420    *
      421    * vstlib.i
      422    *
      423    * VST library definitions
      424    *
      425    */
      426   
      427   function aiInfo returns character ( input vAiFile as character, output vAiGenNum as integer ) in super.
      428   function chkai returns integer ( output ai_exts as integer, output ai_full as integer, output ai_empty as integer ) in super.
      429   function chkarea returns integer ( input threshold as decimal, output worst as decimal ) in super.
      430   function chkptNum returns integer ( input-output oldbi as integer ) in super.
      431   
      432   function connectFlags returns character ( input cnxId as integer ) in super.
      433   function connectName returns character ( input cnxId as integer, input cnxFlags as character ) in super.
      434   function lastStatement returns character( input cnxId as integer, output lineNum as integer, output procName as character ) in super.
      435   
      436   function isAIEnabled returns logical () in super.
      437   function isReplSource returns logical () in super.
      438   function isReplTarget returns logical () in super.
      439   function isBackupRunning returns logical () in super.
      440   function isWorkgroup returns logical () in super.
      441   
      442   function getStartupX returns character ( input v as character, input p1 as character, input p2 as character ) in super.
      443   
      444   /* end vstlib.i */
      445    
      446   
      447   function add2ds returns logical ( input h as handle ) in super.
      448   function getTempTableHandle returns handle ( input n as character ) in super.
      449   
      450   /* end protop.i */
      451    
      452   
      453   /*******************************************************************************
      454    *******************************************************************************
      455    **                                                                           **
      456    **                                                                           **
      457    **  Copyright 2003-2012 Tom Bascom, Greenfield Technologies                  **
      458    **  http://www.greenfieldtech.com                                            **
      459    **                                                                           **
      460    **  ProTop is free software; you can redistribute it and/or modify it        **
      461    **  under the terms of the GNU General Public License (GPL) as published     **
      462    **  by the Free Software Foundation; either version 2 of the License, or     **
      463    **  at your option) any later version.                                       **
      464    **                                                                           **
      465    **  ProTop is distributed in the hope that it will be useful, but WITHOUT    **
      466    **  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or    **
      467    **  FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License     **
      468    **  for more details.                                                        **
      469    **                                                                           **
      470    **  See TERMS.TXT for more information regarding the Terms and Conditions    **
      471    **  of use and alternative licensing options for this software.              **
      472    **                                                                           **
      473    **  A copy of the GPL is in GPL.TXT which was provided with this package.    **
      474    **                                                                           **
      475    **  See http://www.fsf.org for more information about the GPL.               **
      476    **                                                                           **
      477    **                                                                           **
      478    *******************************************************************************
      479    *******************************************************************************
      480    *
      481    * tick.i
      482    *
      483    *
      484    * common routine to handle "clock ticks"
      485    *
      486    *
      487    * Author:
      488    *
      489    *      Tom Bascom, Greenfield Technologies
      490    *      http://www.greenfieldtech.com
      491    *      January 21, 2012
      492    *
      493    */
      494   
      495   
      496   /* lib/v9.i
      497    *
      498    */
      499   
      500   &IF DECIMAL(SUBSTRING(PROVERSION,1,INDEX(PROVERSION,".") + 1)) < 10.0 &THEN
      501   &global-define  CPYLOB  "no"
      502   &global-define  NOW     substitute( "&1 &2", today, string( time, "hh:mm:ss" ))
      503   &global-define  LNGCR   character
      504   &global-define  DTZ     integer
      505   &global-define  BIGINT  decimal
      506   &ELSE
      507   &global-define  OE10    "yes"
      508   &global-define  NOW     now
      509   &global-define  LNGCR   longchar
      510   &global-define  DTZ     datetime-tz
      511   &global-define  BIGINT  int64
      512   &ENDIF
      513    
      514   
      515   define new global shared variable rawMode  as integer no-undo initial 5.
      516   define new global shared variable timeMode as integer no-undo initial 2.
      517   
      518   define new global shared variable x as integer no-undo initial 5.
      519   define new global shared variable z as decimal no-undo.
      520   
      521   define variable y as decimal no-undo.
      522   
      523   define variable initTick as integer no-undo.
      524   define variable prevTick as integer no-undo.
      525   
      526   
      527   procedure updTick:
      528   
      529   &IF DEFINED( OE10 ) &THEN
      530     if initTick = 0 then initTick = mtime.
      531     assign
      532       x = rawMode /* ( if rawMode then 4 else 5 ) */
      533       z = mtime - prevTick
      534       z = ( if z >= 0 then z else 86400000 - prevTick + mtime )   /* handle rolling over midnight */
      535       z = z / 1000
      536       y = mtime - initTick
      537       y = y / 1000
      538       prevTick = mtime
      539     .
      540   &ELSE
      541     if initTick = 0 then initTick = etime.
      542     assign
      543       x = rawMode /* ( if rawMode then 4 else 5 ) */
      544       z = etime - prevTick
      545       z = ( if z >= 0 then z else 5000 )   /* etime doesn't rollover at midnite -- but a mistaken etime(yes) somewhere would be bad... */
      546       z = z / 1000
      547       y = etime - initTick
      548       y = y / 1000
      549       prevTick = etime
      550     .
      551   &ENDIF
      552   
      553     /* if rawMode <> 5 then z = 1. */
      554   
      555     if timeMode = 1 then z = 1.
      556   
      557     return.
      558   
      559   end.
      560   
      561   /* end tick.i */
      562    
      563   
      564   define output parameter dcDescription as character no-undo initial "UserInformation".
      565   
      566   define variable hasOSRd    as logical   no-undo.
      567   
      568   
      569   /*******************************************************************************
      570    *******************************************************************************
      571    **                                                                           **
      572    **                                                                           **
      573    **  Copyright 2003-2006 Tom Bascom, Greenfield Technologies                  **
      574    **  http://www.greenfieldtech.com                                            **
      575    **                                                                           **
      576    **  ProTop is free software; you can redistribute it and/or modify it        **
      577    **  under the terms of the GNU General Public License (GPL) as published     **
      578    **  by the Free Software Foundation; either version 2 of the License, or     **
      579    **  at your option) any later version.                                       **
      580    **                                                                           **
      581    **  ProTop is distributed in the hope that it will be useful, but WITHOUT    **
      582    **  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or    **
      583    **  FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License     **
      584    **  for more details.                                                        **
      585    **                                                                           **
      586    **  See TERMS.TXT for more information regarding the Terms and Conditions    **
      587    **  of use and alternative licensing options for this software.              **
      588    **                                                                           **
      589    **  A copy of the GPL is in GPL.TXT which was provided with this package.    **
      590    **                                                                           **
      591    **  See http://www.fsf.org for more information about the GPL.               **
      592    **                                                                           **
      593    **                                                                           **
      594    *******************************************************************************
      595    *******************************************************************************
      596    *
      597    * tt_xstat.i
      598    *
      599    */
      600   
      601   define variable ratio-calc as integer no-undo.
      602   
      603   define temp-table tt_xstat no-undo
      604     field xid       as integer
      605     field xvalid    as logical
      606     field xname     as character
      607     field misc1     as character
      608     field misc2     as character
      609     field misc3     as character
      610     field misc4     as character
      611     field misc5     as character
      612     field stat1     as decimal extent 5
      613     field stat2     as decimal extent 5
      614     field stat3     as decimal extent 5
      615     field stat4     as decimal extent 5
      616     field stat5     as decimal extent 5
      617     field stat6     as decimal extent 5
      618     field stat-ratio  as decimal
      619     field stat-ratio2 as decimal
      620     index xid-idx is unique primary xid.
      621   
      622   /* this will be called by the including procedure's mon-update procedure
      623    *
      624    */
      625   
      626   procedure update_xstat:
      627   
      628     define input parameter p_xid   as integer   no-undo.
      629     define input parameter p_xname as character no-undo.
      630     define input parameter p_misc1 as character no-undo.
      631     define input parameter p_misc2 as character no-undo.
      632     define input parameter p_misc3 as character no-undo.
      633     define input parameter p_misc4 as character no-undo.
      634     define input parameter p_misc5 as character no-undo.
      635     define input parameter p_this1 as decimal   no-undo.
      636     define input parameter p_this2 as decimal   no-undo.
      637     define input parameter p_this3 as decimal   no-undo.
      638     define input parameter p_this4 as decimal   no-undo.
      639     define input parameter p_this5 as decimal   no-undo.
      640     define input parameter p_this6 as decimal   no-undo.
      641   
      642     find tt_xstat exclusive-lock where tt_xstat.xid = p_xid no-error.
      643   
      644     if not available tt_xstat then
      645       do:
      646   
      647         create tt_xstat.
      648         assign
      649           tt_xstat.xvalid = yes
      650           tt_xstat.xid    = p_xid
      651           tt_xstat.xname  = p_xname
      652           tt_xstat.misc1  = p_misc1
      653           tt_xstat.misc2  = p_misc2
      654           tt_xstat.misc3  = p_misc3
      655           tt_xstat.misc4  = p_misc4
      656           tt_xstat.misc5  = p_misc5
      657           
      658   /*******************************************************************************
      659    *******************************************************************************
      660    **                                                                           **
      661    **                                                                           **
      662    **  Copyright 2003-2006 Tom Bascom, Greenfield Technologies                  **
      663    **  http://www.greenfieldtech.com                                            **
      664    **                                                                           **
      665    **  ProTop is free software; you can redistribute it and/or modify it        **
      666    **  under the terms of the GNU General Public License (GPL) as published     **
      667    **  by the Free Software Foundation; either version 2 of the License, or     **
      668    **  at your option) any later version.                                       **
      669    **                                                                           **
      670    **  ProTop is distributed in the hope that it will be useful, but WITHOUT    **
      671    **  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or    **
      672    **  FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License     **
      673    **  for more details.                                                        **
      674    **                                                                           **
      675    **  See TERMS.TXT for more information regarding the Terms and Conditions    **
      676    **  of use and alternative licensing options for this software.              **
      677    **                                                                           **
      678    **  A copy of the GPL is in GPL.TXT which was provided with this package.    **
      679    **                                                                           **
      680    **  See http://www.fsf.org for more information about the GPL.               **
      681    **                                                                           **
      682    **                                                                           **
      683    *******************************************************************************
      684    *******************************************************************************
      685    *
      686    * init-xrec.i
      687    *
      688    * {1} = base field
      689    * {2} = value to initialze array with
      690    *
      691    * [1] = base
      692    * [2] = last (previous cumulative value)
      693    * [3] = this
      694    * [4] = cumulative
      695    * [5] = interval
      696    *
      697    */
      698   
      699   tt_xstat.stat1[1] = p_this1
      700   tt_xstat.stat1[2] = p_this1
      701   tt_xstat.stat1[3] = p_this1
      702    
      703           
      704   /*******************************************************************************
      705    *******************************************************************************
      706    **                                                                           **
      707    **                                                                           **
      708    **  Copyright 2003-2006 Tom Bascom, Greenfield Technologies                  **
      709    **  http://www.greenfieldtech.com                                            **
      710    **                                                                           **
      711    **  ProTop is free software; you can redistribute it and/or modify it        **
      712    **  under the terms of the GNU General Public License (GPL) as published     **
      713    **  by the Free Software Foundation; either version 2 of the License, or     **
      714    **  at your option) any later version.                                       **
      715    **                                                                           **
      716    **  ProTop is distributed in the hope that it will be useful, but WITHOUT    **
      717    **  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or    **
      718    **  FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License     **
      719    **  for more details.                                                        **
      720    **                                                                           **
      721    **  See TERMS.TXT for more information regarding the Terms and Conditions    **
      722    **  of use and alternative licensing options for this software.              **
      723    **                                                                           **
      724    **  A copy of the GPL is in GPL.TXT which was provided with this package.    **
      725    **                                                                           **
      726    **  See http://www.fsf.org for more information about the GPL.               **
      727    **                                                                           **
      728    **                                                                           **
      729    *******************************************************************************
      730    *******************************************************************************
      731    *
      732    * init-xrec.i
      733    *
      734    * {1} = base field
      735    * {2} = value to initialze array with
      736    *
      737    * [1] = base
      738    * [2] = last (previous cumulative value)
      739    * [3] = this
      740    * [4] = cumulative
      741    * [5] = interval
      742    *
      743    */
      744   
      745   tt_xstat.stat2[1] = p_this2
      746   tt_xstat.stat2[2] = p_this2
      747   tt_xstat.stat2[3] = p_this2
      748    
      749           
      750   /*******************************************************************************
      751    *******************************************************************************
      752    **                                                                           **
      753    **                                                                           **
      754    **  Copyright 2003-2006 Tom Bascom, Greenfield Technologies                  **
      755    **  http://www.greenfieldtech.com                                            **
      756    **                                                                           **
      757    **  ProTop is free software; you can redistribute it and/or modify it        **
      758    **  under the terms of the GNU General Public License (GPL) as published     **
      759    **  by the Free Software Foundation; either version 2 of the License, or     **
      760    **  at your option) any later version.                                       **
      761    **                                                                           **
      762    **  ProTop is distributed in the hope that it will be useful, but WITHOUT    **
      763    **  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or    **
      764    **  FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License     **
      765    **  for more details.                                                        **
      766    **                                                                           **
      767    **  See TERMS.TXT for more information regarding the Terms and Conditions    **
      768    **  of use and alternative licensing options for this software.              **
      769    **                                                                           **
      770    **  A copy of the GPL is in GPL.TXT which was provided with this package.    **
      771    **                                                                           **
      772    **  See http://www.fsf.org for more information about the GPL.               **
      773    **                                                                           **
      774    **                                                                           **
      775    *******************************************************************************
      776    *******************************************************************************
      777    *
      778    * init-xrec.i
      779    *
      780    * {1} = base field
      781    * {2} = value to initialze array with
      782    *
      783    * [1] = base
      784    * [2] = last (previous cumulative value)
      785    * [3] = this
      786    * [4] = cumulative
      787    * [5] = interval
      788    *
      789    */
      790   
      791   tt_xstat.stat3[1] = p_this3
      792   tt_xstat.stat3[2] = p_this3
      793   tt_xstat.stat3[3] = p_this3
      794    
      795           
      796   /*******************************************************************************
      797    *******************************************************************************
      798    **                                                                           **
      799    **                                                                           **
      800    **  Copyright 2003-2006 Tom Bascom, Greenfield Technologies                  **
      801    **  http://www.greenfieldtech.com                                            **
      802    **                                                                           **
      803    **  ProTop is free software; you can redistribute it and/or modify it        **
      804    **  under the terms of the GNU General Public License (GPL) as published     **
      805    **  by the Free Software Foundation; either version 2 of the License, or     **
      806    **  at your option) any later version.                                       **
      807    **                                                                           **
      808    **  ProTop is distributed in the hope that it will be useful, but WITHOUT    **
      809    **  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or    **
      810    **  FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License     **
      811    **  for more details.                                                        **
      812    **                                                                           **
      813    **  See TERMS.TXT for more information regarding the Terms and Conditions    **
      814    **  of use and alternative licensing options for this software.              **
      815    **                                                                           **
      816    **  A copy of the GPL is in GPL.TXT which was provided with this package.    **
      817    **                                                                           **
      818    **  See http://www.fsf.org for more information about the GPL.               **
      819    **                                                                           **
      820    **                                                                           **
      821    *******************************************************************************
      822    *******************************************************************************
      823    *
      824    * init-xrec.i
      825    *
      826    * {1} = base field
      827    * {2} = value to initialze array with
      828    *
      829    * [1] = base
      830    * [2] = last (previous cumulative value)
      831    * [3] = this
      832    * [4] = cumulative
      833    * [5] = interval
      834    *
      835    */
      836   
      837   tt_xstat.stat4[1] = p_this4
      838   tt_xstat.stat4[2] = p_this4
      839   tt_xstat.stat4[3] = p_this4
      840    
      841           
      842   /*******************************************************************************
      843    *******************************************************************************
      844    **                                                                           **
      845    **                                                                           **
      846    **  Copyright 2003-2006 Tom Bascom, Greenfield Technologies                  **
      847    **  http://www.greenfieldtech.com                                            **
      848    **                                                                           **
      849    **  ProTop is free software; you can redistribute it and/or modify it        **
      850    **  under the terms of the GNU General Public License (GPL) as published     **
      851    **  by the Free Software Foundation; either version 2 of the License, or     **
      852    **  at your option) any later version.                                       **
      853    **                                                                           **
      854    **  ProTop is distributed in the hope that it will be useful, but WITHOUT    **
      855    **  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or    **
      856    **  FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License     **
      857    **  for more details.                                                        **
      858    **                                                                           **
      859    **  See TERMS.TXT for more information regarding the Terms and Conditions    **
      860    **  of use and alternative licensing options for this software.              **
      861    **                                                                           **
      862    **  A copy of the GPL is in GPL.TXT which was provided with this package.    **
      863    **                                                                           **
      864    **  See http://www.fsf.org for more information about the GPL.               **
      865    **                                                                           **
      866    **                                                                           **
      867    *******************************************************************************
      868    *******************************************************************************
      869    *
      870    * init-xrec.i
      871    *
      872    * {1} = base field
      873    * {2} = value to initialze array with
      874    *
      875    * [1] = base
      876    * [2] = last (previous cumulative value)
      877    * [3] = this
      878    * [4] = cumulative
      879    * [5] = interval
      880    *
      881    */
      882   
      883   tt_xstat.stat5[1] = p_this5
      884   tt_xstat.stat5[2] = p_this5
      885   tt_xstat.stat5[3] = p_this5
      886    
      887           
      888   /*******************************************************************************
      889    *******************************************************************************
      890    **                                                                           **
      891    **                                                                           **
      892    **  Copyright 2003-2006 Tom Bascom, Greenfield Technologies                  **
      893    **  http://www.greenfieldtech.com                                            **
      894    **                                                                           **
      895    **  ProTop is free software; you can redistribute it and/or modify it        **
      896    **  under the terms of the GNU General Public License (GPL) as published     **
      897    **  by the Free Software Foundation; either version 2 of the License, or     **
      898    **  at your option) any later version.                                       **
      899    **                                                                           **
      900    **  ProTop is distributed in the hope that it will be useful, but WITHOUT    **
      901    **  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or    **
      902    **  FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License     **
      903    **  for more details.                                                        **
      904    **                                                                           **
      905    **  See TERMS.TXT for more information regarding the Terms and Conditions    **
      906    **  of use and alternative licensing options for this software.              **
      907    **                                                                           **
      908    **  A copy of the GPL is in GPL.TXT which was provided with this package.    **
      909    **                                                                           **
      910    **  See http://www.fsf.org for more information about the GPL.               **
      911    **                                                                           **
      912    **                                                                           **
      913    *******************************************************************************
      914    *******************************************************************************
      915    *
      916    * init-xrec.i
      917    *
      918    * {1} = base field
      919    * {2} = value to initialze array with
      920    *
      921    * [1] = base
      922    * [2] = last (previous cumulative value)
      923    * [3] = this
      924    * [4] = cumulative
      925    * [5] = interval
      926    *
      927    */
      928   
      929   tt_xstat.stat6[1] = p_this6
      930   tt_xstat.stat6[2] = p_this6
      931   tt_xstat.stat6[3] = p_this6
      932    
      933         .
      934   
      935       end.
      936      else
      937       do:
      938   
      939         assign
      940           tt_xstat.xvalid   = yes                         /* is this xid active?          */
      941           tt_xstat.xname    = p_xname                     /* reuse of ids is possible...  */
      942           tt_xstat.misc1    = p_misc1
      943           tt_xstat.misc2    = p_misc2
      944           tt_xstat.misc3    = p_misc3
      945           tt_xstat.misc4    = p_misc4
      946           tt_xstat.misc5    = p_misc5
      947           tt_xstat.stat1[3] = p_this1
      948           tt_xstat.stat2[3] = p_this2
      949           tt_xstat.stat3[3] = p_this3
      950           tt_xstat.stat4[3] = p_this4
      951           tt_xstat.stat5[3] = p_this5
      952           tt_xstat.stat6[3] = p_this6
      953         .
      954   
      955         if tt_xstat.stat1[3] < tt_xstat.stat1[3] then     /* detect reuse of an id (stat rolling backwards...)    */
      956           assign
      957             tt_xstat.xname  = p_xname
      958             
      959   /*******************************************************************************
      960    *******************************************************************************
      961    **                                                                           **
      962    **                                                                           **
      963    **  Copyright 2003-2006 Tom Bascom, Greenfield Technologies                  **
      964    **  http://www.greenfieldtech.com                                            **
      965    **                                                                           **
      966    **  ProTop is free software; you can redistribute it and/or modify it        **
      967    **  under the terms of the GNU General Public License (GPL) as published     **
      968    **  by the Free Software Foundation; either version 2 of the License, or     **
      969    **  at your option) any later version.                                       **
      970    **                                                                           **
      971    **  ProTop is distributed in the hope that it will be useful, but WITHOUT    **
      972    **  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or    **
      973    **  FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License     **
      974    **  for more details.                                                        **
      975    **                                                                           **
      976    **  See TERMS.TXT for more information regarding the Terms and Conditions    **
      977    **  of use and alternative licensing options for this software.              **
      978    **                                                                           **
      979    **  A copy of the GPL is in GPL.TXT which was provided with this package.    **
      980    **                                                                           **
      981    **  See http://www.fsf.org for more information about the GPL.               **
      982    **                                                                           **
      983    **                                                                           **
      984    *******************************************************************************
      985    *******************************************************************************
      986    *
      987    * init-xrec.i
      988    *
      989    * {1} = base field
      990    * {2} = value to initialze array with
      991    *
      992    * [1] = base
      993    * [2] = last (previous cumulative value)
      994    * [3] = this
      995    * [4] = cumulative
      996    * [5] = interval
      997    *
      998    */
      999   
     1000   tt_xstat.stat1[1] = p_this1
     1001   tt_xstat.stat1[2] = p_this1
     1002   tt_xstat.stat1[3] = p_this1
     1003    
     1004             
     1005   /*******************************************************************************
     1006    *******************************************************************************
     1007    **                                                                           **
     1008    **                                                                           **
     1009    **  Copyright 2003-2006 Tom Bascom, Greenfield Technologies                  **
     1010    **  http://www.greenfieldtech.com                                            **
     1011    **                                                                           **
     1012    **  ProTop is free software; you can redistribute it and/or modify it        **
     1013    **  under the terms of the GNU General Public License (GPL) as published     **
     1014    **  by the Free Software Foundation; either version 2 of the License, or     **
     1015    **  at your option) any later version.                                       **
     1016    **                                                                           **
     1017    **  ProTop is distributed in the hope that it will be useful, but WITHOUT    **
     1018    **  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or    **
     1019    **  FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License     **
     1020    **  for more details.                                                        **
     1021    **                                                                           **
     1022    **  See TERMS.TXT for more information regarding the Terms and Conditions    **
     1023    **  of use and alternative licensing options for this software.              **
     1024    **                                                                           **
     1025    **  A copy of the GPL is in GPL.TXT which was provided with this package.    **
     1026    **                                                                           **
     1027    **  See http://www.fsf.org for more information about the GPL.               **
     1028    **                                                                           **
     1029    **                                                                           **
     1030    *******************************************************************************
     1031    *******************************************************************************
     1032    *
     1033    * init-xrec.i
     1034    *
     1035    * {1} = base field
     1036    * {2} = value to initialze array with
     1037    *
     1038    * [1] = base
     1039    * [2] = last (previous cumulative value)
     1040    * [3] = this
     1041    * [4] = cumulative
     1042    * [5] = interval
     1043    *
     1044    */
     1045   
     1046   tt_xstat.stat2[1] = p_this2
     1047   tt_xstat.stat2[2] = p_this2
     1048   tt_xstat.stat2[3] = p_this2
     1049    
     1050             
     1051   /*******************************************************************************
     1052    *******************************************************************************
     1053    **                                                                           **
     1054    **                                                                           **
     1055    **  Copyright 2003-2006 Tom Bascom, Greenfield Technologies                  **
     1056    **  http://www.greenfieldtech.com                                            **
     1057    **                                                                           **
     1058    **  ProTop is free software; you can redistribute it and/or modify it        **
     1059    **  under the terms of the GNU General Public License (GPL) as published     **
     1060    **  by the Free Software Foundation; either version 2 of the License, or     **
     1061    **  at your option) any later version.                                       **
     1062    **                                                                           **
     1063    **  ProTop is distributed in the hope that it will be useful, but WITHOUT    **
     1064    **  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or    **
     1065    **  FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License     **
     1066    **  for more details.                                                        **
     1067    **                                                                           **
     1068    **  See TERMS.TXT for more information regarding the Terms and Conditions    **
     1069    **  of use and alternative licensing options for this software.              **
     1070    **                                                                           **
     1071    **  A copy of the GPL is in GPL.TXT which was provided with this package.    **
     1072    **                                                                           **
     1073    **  See http://www.fsf.org for more information about the GPL.               **
     1074    **                                                                           **
     1075    **                                                                           **
     1076    *******************************************************************************
     1077    *******************************************************************************
     1078    *
     1079    * init-xrec.i
     1080    *
     1081    * {1} = base field
     1082    * {2} = value to initialze array with
     1083    *
     1084    * [1] = base
     1085    * [2] = last (previous cumulative value)
     1086    * [3] = this
     1087    * [4] = cumulative
     1088    * [5] = interval
     1089    *
     1090    */
     1091   
     1092   tt_xstat.stat3[1] = p_this3
     1093   tt_xstat.stat3[2] = p_this3
     1094   tt_xstat.stat3[3] = p_this3
     1095    
     1096             
     1097   /*******************************************************************************
     1098    *******************************************************************************
     1099    **                                                                           **
     1100    **                                                                           **
     1101    **  Copyright 2003-2006 Tom Bascom, Greenfield Technologies                  **
     1102    **  http://www.greenfieldtech.com                                            **
     1103    **                                                                           **
     1104    **  ProTop is free software; you can redistribute it and/or modify it        **
     1105    **  under the terms of the GNU General Public License (GPL) as published     **
     1106    **  by the Free Software Foundation; either version 2 of the License, or     **
     1107    **  at your option) any later version.                                       **
     1108    **                                                                           **
     1109    **  ProTop is distributed in the hope that it will be useful, but WITHOUT    **
     1110    **  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or    **
     1111    **  FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License     **
     1112    **  for more details.                                                        **
     1113    **                                                                           **
     1114    **  See TERMS.TXT for more information regarding the Terms and Conditions    **
     1115    **  of use and alternative licensing options for this software.              **
     1116    **                                                                           **
     1117    **  A copy of the GPL is in GPL.TXT which was provided with this package.    **
     1118    **                                                                           **
     1119    **  See http://www.fsf.org for more information about the GPL.               **
     1120    **                                                                           **
     1121    **                                                                           **
     1122    *******************************************************************************
     1123    *******************************************************************************
     1124    *
     1125    * init-xrec.i
     1126    *
     1127    * {1} = base field
     1128    * {2} = value to initialze array with
     1129    *
     1130    * [1] = base
     1131    * [2] = last (previous cumulative value)
     1132    * [3] = this
     1133    * [4] = cumulative
     1134    * [5] = interval
     1135    *
     1136    */
     1137   
     1138   tt_xstat.stat4[1] = p_this4
     1139   tt_xstat.stat4[2] = p_this4
     1140   tt_xstat.stat4[3] = p_this4
     1141    
     1142             
     1143   /*******************************************************************************
     1144    *******************************************************************************
     1145    **                                                                           **
     1146    **                                                                           **
     1147    **  Copyright 2003-2006 Tom Bascom, Greenfield Technologies                  **
     1148    **  http://www.greenfieldtech.com                                            **
     1149    **                                                                           **
     1150    **  ProTop is free software; you can redistribute it and/or modify it        **
     1151    **  under the terms of the GNU General Public License (GPL) as published     **
     1152    **  by the Free Software Foundation; either version 2 of the License, or     **
     1153    **  at your option) any later version.                                       **
     1154    **                                                                           **
     1155    **  ProTop is distributed in the hope that it will be useful, but WITHOUT    **
     1156    **  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or    **
     1157    **  FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License     **
     1158    **  for more details.                                                        **
     1159    **                                                                           **
     1160    **  See TERMS.TXT for more information regarding the Terms and Conditions    **
     1161    **  of use and alternative licensing options for this software.              **
     1162    **                                                                           **
     1163    **  A copy of the GPL is in GPL.TXT which was provided with this package.    **
     1164    **                                                                           **
     1165    **  See http://www.fsf.org for more information about the GPL.               **
     1166    **                                                                           **
     1167    **                                                                           **
     1168    *******************************************************************************
     1169    *******************************************************************************
     1170    *
     1171    * init-xrec.i
     1172    *
     1173    * {1} = base field
     1174    * {2} = value to initialze array with
     1175    *
     1176    * [1] = base
     1177    * [2] = last (previous cumulative value)
     1178    * [3] = this
     1179    * [4] = cumulative
     1180    * [5] = interval
     1181    *
     1182    */
     1183   
     1184   tt_xstat.stat5[1] = p_this5
     1185   tt_xstat.stat5[2] = p_this5
     1186   tt_xstat.stat5[3] = p_this5
     1187    
     1188             
     1189   /*******************************************************************************
     1190    *******************************************************************************
     1191    **                                                                           **
     1192    **                                                                           **
     1193    **  Copyright 2003-2006 Tom Bascom, Greenfield Technologies                  **
     1194    **  http://www.greenfieldtech.com                                            **
     1195    **                                                                           **
     1196    **  ProTop is free software; you can redistribute it and/or modify it        **
     1197    **  under the terms of the GNU General Public License (GPL) as published     **
     1198    **  by the Free Software Foundation; either version 2 of the License, or     **
     1199    **  at your option) any later version.                                       **
     1200    **                                                                           **
     1201    **  ProTop is distributed in the hope that it will be useful, but WITHOUT    **
     1202    **  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or    **
     1203    **  FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License     **
     1204    **  for more details.                                                        **
     1205    **                                                                           **
     1206    **  See TERMS.TXT for more information regarding the Terms and Conditions    **
     1207    **  of use and alternative licensing options for this software.              **
     1208    **                                                                           **
     1209    **  A copy of the GPL is in GPL.TXT which was provided with this package.    **
     1210    **                                                                           **
     1211    **  See http://www.fsf.org for more information about the GPL.               **
     1212    **                                                                           **
     1213    **                                                                           **
     1214    *******************************************************************************
     1215    *******************************************************************************
     1216    *
     1217    * init-xrec.i
     1218    *
     1219    * {1} = base field
     1220    * {2} = value to initialze array with
     1221    *
     1222    * [1] = base
     1223    * [2] = last (previous cumulative value)
     1224    * [3] = this
     1225    * [4] = cumulative
     1226    * [5] = interval
     1227    *
     1228    */
     1229   
     1230   tt_xstat.stat6[1] = p_this6
     1231   tt_xstat.stat6[2] = p_this6
     1232   tt_xstat.stat6[3] = p_this6
     1233    
     1234           .
     1235   
     1236       end.
     1237   
     1238     return.
     1239   
     1240   end.
     1241   
     1242   /* this will be called by the including procedure's mon-update procedure
     1243    *
     1244    */
     1245   
     1246   procedure age_xstat:
     1247   
     1248     define variable x as integer   no-undo.
     1249     define variable z as integer   no-undo.
     1250     define variable r as character no-undo case-sensitive initial "r".
     1251     define variable s as character no-undo case-sensitive initial "s".
     1252   
     1253     publish "get-RateRaw" ( output r ).
     1254     publish "get-SumSample" ( output s ).
     1255   
     1256     if s = "S" then
     1257       assign
     1258         x = 4
     1259         z = xtime.
     1260      else
     1261       assign
     1262         x = 5
     1263         z = itime.
     1264   
     1265     for each tt_xstat exclusive-lock:
     1266   
     1267       if tt_xstat.xvalid = no then
     1268         delete tt_xstat.
     1269        else
     1270         do:
     1271           assign
     1272             tt_xstat.xvalid = no
     1273             
     1274   /*******************************************************************************
     1275    *******************************************************************************
     1276    **                                                                           **
     1277    **                                                                           **
     1278    **  Copyright 2003-2006 Tom Bascom, Greenfield Technologies                  **
     1279    **  http://www.greenfieldtech.com                                            **
     1280    **                                                                           **
     1281    **  ProTop is free software; you can redistribute it and/or modify it        **
     1282    **  under the terms of the GNU General Public License (GPL) as published     **
     1283    **  by the Free Software Foundation; either version 2 of the License, or     **
     1284    **  at your option) any later version.                                       **
     1285    **                                                                           **
     1286    **  ProTop is distributed in the hope that it will be useful, but WITHOUT    **
     1287    **  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or    **
     1288    **  FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License     **
     1289    **  for more details.                                                        **
     1290    **                                                                           **
     1291    **  See TERMS.TXT for more information regarding the Terms and Conditions    **
     1292    **  of use and alternative licensing options for this software.              **
     1293    **                                                                           **
     1294    **  A copy of the GPL is in GPL.TXT which was provided with this package.    **
     1295    **                                                                           **
     1296    **  See http://www.fsf.org for more information about the GPL.               **
     1297    **                                                                           **
     1298    **                                                                           **
     1299    *******************************************************************************
     1300    *******************************************************************************
     1301    *
     1302    * upd-xrec.i
     1303    *
     1304    * {1} = base field
     1305    * {2} = value to update metrics with
     1306    *
     1307    * [1] = base
     1308    * [2] = last (previous cumulative value)
     1309    * [3] = this
     1310    * [4] = cumulative
     1311    * [5] = interval
     1312    *
     1313    */
     1314   
     1315   tt_xstat.stat1[3] = tt_xstat.stat1[3]
     1316   tt_xstat.stat1[4] = tt_xstat.stat1[3] - tt_xstat.stat1[1]
     1317   tt_xstat.stat1[5] = tt_xstat.stat1[3] - tt_xstat.stat1[2]
     1318   tt_xstat.stat1[2] = tt_xstat.stat1[3]
     1319    
     1320             
     1321   /*******************************************************************************
     1322    *******************************************************************************
     1323    **                                                                           **
     1324    **                                                                           **
     1325    **  Copyright 2003-2006 Tom Bascom, Greenfield Technologies                  **
     1326    **  http://www.greenfieldtech.com                                            **
     1327    **                                                                           **
     1328    **  ProTop is free software; you can redistribute it and/or modify it        **
     1329    **  under the terms of the GNU General Public License (GPL) as published     **
     1330    **  by the Free Software Foundation; either version 2 of the License, or     **
     1331    **  at your option) any later version.                                       **
     1332    **                                                                           **
     1333    **  ProTop is distributed in the hope that it will be useful, but WITHOUT    **
     1334    **  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or    **
     1335    **  FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License     **
     1336    **  for more details.                                                        **
     1337    **                                                                           **
     1338    **  See TERMS.TXT for more information regarding the Terms and Conditions    **
     1339    **  of use and alternative licensing options for this software.              **
     1340    **                                                                           **
     1341    **  A copy of the GPL is in GPL.TXT which was provided with this package.    **
     1342    **                                                                           **
     1343    **  See http://www.fsf.org for more information about the GPL.               **
     1344    **                                                                           **
     1345    **                                                                           **
     1346    *******************************************************************************
     1347    *******************************************************************************
     1348    *
     1349    * upd-xrec.i
     1350    *
     1351    * {1} = base field
     1352    * {2} = value to update metrics with
     1353    *
     1354    * [1] = base
     1355    * [2] = last (previous cumulative value)
     1356    * [3] = this
     1357    * [4] = cumulative
     1358    * [5] = interval
     1359    *
     1360    */
     1361   
     1362   tt_xstat.stat2[3] = tt_xstat.stat2[3]
     1363   tt_xstat.stat2[4] = tt_xstat.stat2[3] - tt_xstat.stat2[1]
     1364   tt_xstat.stat2[5] = tt_xstat.stat2[3] - tt_xstat.stat2[2]
     1365   tt_xstat.stat2[2] = tt_xstat.stat2[3]
     1366    
     1367             
     1368   /*******************************************************************************
     1369    *******************************************************************************
     1370    **                                                                           **
     1371    **                                                                           **
     1372    **  Copyright 2003-2006 Tom Bascom, Greenfield Technologies                  **
     1373    **  http://www.greenfieldtech.com                                            **
     1374    **                                                                           **
     1375    **  ProTop is free software; you can redistribute it and/or modify it        **
     1376    **  under the terms of the GNU General Public License (GPL) as published     **
     1377    **  by the Free Software Foundation; either version 2 of the License, or     **
     1378    **  at your option) any later version.                                       **
     1379    **                                                                           **
     1380    **  ProTop is distributed in the hope that it will be useful, but WITHOUT    **
     1381    **  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or    **
     1382    **  FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License     **
     1383    **  for more details.                                                        **
     1384    **                                                                           **
     1385    **  See TERMS.TXT for more information regarding the Terms and Conditions    **
     1386    **  of use and alternative licensing options for this software.              **
     1387    **                                                                           **
     1388    **  A copy of the GPL is in GPL.TXT which was provided with this package.    **
     1389    **                                                                           **
     1390    **  See http://www.fsf.org for more information about the GPL.               **
     1391    **                                                                           **
     1392    **                                                                           **
     1393    *******************************************************************************
     1394    *******************************************************************************
     1395    *
     1396    * upd-xrec.i
     1397    *
     1398    * {1} = base field
     1399    * {2} = value to update metrics with
     1400    *
     1401    * [1] = base
     1402    * [2] = last (previous cumulative value)
     1403    * [3] = this
     1404    * [4] = cumulative
     1405    * [5] = interval
     1406    *
     1407    */
     1408   
     1409   tt_xstat.stat3[3] = tt_xstat.stat3[3]
     1410   tt_xstat.stat3[4] = tt_xstat.stat3[3] - tt_xstat.stat3[1]
     1411   tt_xstat.stat3[5] = tt_xstat.stat3[3] - tt_xstat.stat3[2]
     1412   tt_xstat.stat3[2] = tt_xstat.stat3[3]
     1413    
     1414             
     1415   /*******************************************************************************
     1416    *******************************************************************************
     1417    **                                                                           **
     1418    **                                                                           **
     1419    **  Copyright 2003-2006 Tom Bascom, Greenfield Technologies                  **
     1420    **  http://www.greenfieldtech.com                                            **
     1421    **                                                                           **
     1422    **  ProTop is free software; you can redistribute it and/or modify it        **
     1423    **  under the terms of the GNU General Public License (GPL) as published     **
     1424    **  by the Free Software Foundation; either version 2 of the License, or     **
     1425    **  at your option) any later version.                                       **
     1426    **                                                                           **
     1427    **  ProTop is distributed in the hope that it will be useful, but WITHOUT    **
     1428    **  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or    **
     1429    **  FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License     **
     1430    **  for more details.                                                        **
     1431    **                                                                           **
     1432    **  See TERMS.TXT for more information regarding the Terms and Conditions    **
     1433    **  of use and alternative licensing options for this software.              **
     1434    **                                                                           **
     1435    **  A copy of the GPL is in GPL.TXT which was provided with this package.    **
     1436    **                                                                           **
     1437    **  See http://www.fsf.org for more information about the GPL.               **
     1438    **                                                                           **
     1439    **                                                                           **
     1440    *******************************************************************************
     1441    *******************************************************************************
     1442    *
     1443    * upd-xrec.i
     1444    *
     1445    * {1} = base field
     1446    * {2} = value to update metrics with
     1447    *
     1448    * [1] = base
     1449    * [2] = last (previous cumulative value)
     1450    * [3] = this
     1451    * [4] = cumulative
     1452    * [5] = interval
     1453    *
     1454    */
     1455   
     1456   tt_xstat.stat4[3] = tt_xstat.stat4[3]
     1457   tt_xstat.stat4[4] = tt_xstat.stat4[3] - tt_xstat.stat4[1]
     1458   tt_xstat.stat4[5] = tt_xstat.stat4[3] - tt_xstat.stat4[2]
     1459   tt_xstat.stat4[2] = tt_xstat.stat4[3]
     1460    
     1461             
     1462   /*******************************************************************************
     1463    *******************************************************************************
     1464    **                                                                           **
     1465    **                                                                           **
     1466    **  Copyright 2003-2006 Tom Bascom, Greenfield Technologies                  **
     1467    **  http://www.greenfieldtech.com                                            **
     1468    **                                                                           **
     1469    **  ProTop is free software; you can redistribute it and/or modify it        **
     1470    **  under the terms of the GNU General Public License (GPL) as published     **
     1471    **  by the Free Software Foundation; either version 2 of the License, or     **
     1472    **  at your option) any later version.                                       **
     1473    **                                                                           **
     1474    **  ProTop is distributed in the hope that it will be useful, but WITHOUT    **
     1475    **  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or    **
     1476    **  FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License     **
     1477    **  for more details.                                                        **
     1478    **                                                                           **
     1479    **  See TERMS.TXT for more information regarding the Terms and Conditions    **
     1480    **  of use and alternative licensing options for this software.              **
     1481    **                                                                           **
     1482    **  A copy of the GPL is in GPL.TXT which was provided with this package.    **
     1483    **                                                                           **
     1484    **  See http://www.fsf.org for more information about the GPL.               **
     1485    **                                                                           **
     1486    **                                                                           **
     1487    *******************************************************************************
     1488    *******************************************************************************
     1489    *
     1490    * upd-xrec.i
     1491    *
     1492    * {1} = base field
     1493    * {2} = value to update metrics with
     1494    *
     1495    * [1] = base
     1496    * [2] = last (previous cumulative value)
     1497    * [3] = this
     1498    * [4] = cumulative
     1499    * [5] = interval
     1500    *
     1501    */
     1502   
     1503   tt_xstat.stat5[3] = tt_xstat.stat5[3]
     1504   tt_xstat.stat5[4] = tt_xstat.stat5[3] - tt_xstat.stat5[1]
     1505   tt_xstat.stat5[5] = tt_xstat.stat5[3] - tt_xstat.stat5[2]
     1506   tt_xstat.stat5[2] = tt_xstat.stat5[3]
     1507    
     1508             
     1509   /*******************************************************************************
     1510    *******************************************************************************
     1511    **                                                                           **
     1512    **                                                                           **
     1513    **  Copyright 2003-2006 Tom Bascom, Greenfield Technologies                  **
     1514    **  http://www.greenfieldtech.com                                            **
     1515    **                                                                           **
     1516    **  ProTop is free software; you can redistribute it and/or modify it        **
     1517    **  under the terms of the GNU General Public License (GPL) as published     **
     1518    **  by the Free Software Foundation; either version 2 of the License, or     **
     1519    **  at your option) any later version.                                       **
     1520    **                                                                           **
     1521    **  ProTop is distributed in the hope that it will be useful, but WITHOUT    **
     1522    **  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or    **
     1523    **  FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License     **
     1524    **  for more details.                                                        **
     1525    **                                                                           **
     1526    **  See TERMS.TXT for more information regarding the Terms and Conditions    **
     1527    **  of use and alternative licensing options for this software.              **
     1528    **                                                                           **
     1529    **  A copy of the GPL is in GPL.TXT which was provided with this package.    **
     1530    **                                                                           **
     1531    **  See http://www.fsf.org for more information about the GPL.               **
     1532    **                                                                           **
     1533    **                                                                           **
     1534    *******************************************************************************
     1535    *******************************************************************************
     1536    *
     1537    * upd-xrec.i
     1538    *
     1539    * {1} = base field
     1540    * {2} = value to update metrics with
     1541    *
     1542    * [1] = base
     1543    * [2] = last (previous cumulative value)
     1544    * [3] = this
     1545    * [4] = cumulative
     1546    * [5] = interval
     1547    *
     1548    */
     1549   
     1550   tt_xstat.stat6[3] = tt_xstat.stat6[3]
     1551   tt_xstat.stat6[4] = tt_xstat.stat6[3] - tt_xstat.stat6[1]
     1552   tt_xstat.stat6[5] = tt_xstat.stat6[3] - tt_xstat.stat6[2]
     1553   tt_xstat.stat6[2] = tt_xstat.stat6[3]
     1554    
     1555           .
     1556   
     1557           if ratio-calc = 0 then
     1558             assign
     1559               tt_xstat.stat-ratio  = 100 * (( tt_xstat.stat1[x] - tt_xstat.stat2[x] ) / tt_xstat.stat1[x] )
     1560               tt_xstat.stat-ratio  = ( if tt_xstat.stat-ratio = ? then 0 else tt_xstat.stat-ratio )
     1561               tt_xstat.stat-ratio2  = 100 * (( tt_xstat.stat3[x] - tt_xstat.stat4[x] ) / tt_xstat.stat3[x] )
     1562               tt_xstat.stat-ratio2  = ( if tt_xstat.stat-ratio2 = ? then 0 else tt_xstat.stat-ratio2 )
     1563             .
     1564            else if ratio-calc = 1 then
     1565             assign
     1566               tt_xstat.stat-ratio  = 100 * ( tt_xstat.stat1[x] / tt_xstat.stat2[x] )
     1567               tt_xstat.stat-ratio  = ( if tt_xstat.stat-ratio = ? then 0 else tt_xstat.stat-ratio )
     1568               tt_xstat.stat-ratio2  = 100 * ( tt_xstat.stat3[x] / tt_xstat.stat4[x] )
     1569               tt_xstat.stat-ratio2  = ( if tt_xstat.stat-ratio2 = ? then 0 else tt_xstat.stat-ratio2 )
     1570             .
     1571         end.
     1572   
     1573     end.
     1574   
     1575     return.
     1576   
     1577   end.
     1578    
     1579   
     1580   /*******************************************************************************
     1581    *******************************************************************************
     1582    **                                                                           **
     1583    **                                                                           **
     1584    **  Copyright 2003-2006 Tom Bascom, Greenfield Technologies                  **
     1585    **  http://www.greenfieldtech.com                                            **
     1586    **                                                                           **
     1587    **  ProTop is free software; you can redistribute it and/or modify it        **
     1588    **  under the terms of the GNU General Public License (GPL) as published     **
     1589    **  by the Free Software Foundation; either version 2 of the License, or     **
     1590    **  at your option) any later version.                                       **
     1591    **                                                                           **
     1592    **  ProTop is distributed in the hope that it will be useful, but WITHOUT    **
     1593    **  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or    **
     1594    **  FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License     **
     1595    **  for more details.                                                        **
     1596    **                                                                           **
     1597    **  See TERMS.TXT for more information regarding the Terms and Conditions    **
     1598    **  of use and alternative licensing options for this software.              **
     1599    **                                                                           **
     1600    **  A copy of the GPL is in GPL.TXT which was provided with this package.    **
     1601    **                                                                           **
     1602    **  See http://www.fsf.org for more information about the GPL.               **
     1603    **                                                                           **
     1604    **                                                                           **
     1605    *******************************************************************************
     1606    *******************************************************************************
     1607    *
     1608    * tt_utable.i
     1609    *
     1610    */
     1611   
     1612   define temp-table tt_utable no-undo
     1613     field xid      as integer
     1614     field xvalid   as logical
     1615     field tblNum   as integer
     1616     field tblName  as character
     1617     field areaNum  as integer
     1618     field usrNum   as integer
     1619     field usrName  as character
     1620     field ttbl     as character
     1621     field tbl-cre  as decimal extent 5
     1622     field tbl-rd   as decimal extent 5
     1623     field tbl-upd  as decimal extent 5
     1624     field tbl-del  as decimal extent 5
     1625     field tbl-osrd as decimal extent 5
     1626     index xid-idx is unique primary xid.
     1627   
     1628   define variable tBase   as integer no-undo.
     1629   define variable tRange  as integer no-undo.
     1630   define variable tUsed   as integer no-undo.
     1631   
     1632   tBase = recid( _tableStat ).
     1633   find last  dictDB._tableStat no-lock.
     1634   tRange  = recid( _tableStat ).
     1635   
     1636   tUsed = 0.
     1637   for each dictDB._file no-lock where _hidden = no:
     1638     tUsed = tUsed + 1.
     1639   end.
     1640   
     1641   procedure upd-tt_utable:
     1642   
     1643     define input parameter p_tbl as integer no-undo.
     1644   
     1645     define variable x as integer no-undo.
     1646     define variable z as integer no-undo.
     1647   
     1648     define variable bh  as handle no-undo.
     1649     define variable bf  as handle no-undo.
     1650   
     1651     do-SumSample( output x, output z ).
     1652   
     1653   &IF DECIMAL(SUBSTRING(PROVERSION,1,INDEX(PROVERSION,".") + 1)) >= 10.1 AND PROVERSION >= "10.1B" &THEN
     1654     find dictdb._userTableStat no-lock where _userTableStat-id = p_tbl no-error.
     1655     find tt_tbl no-lock where tt_tbl.xid = _userTableStat-num no-error.
     1656   &ENDIF
     1657   
     1658     if not available tt_tbl then return.
     1659   
     1660     find dictdb._connect no-lock
     1661   &IF DECIMAL(SUBSTRING(PROVERSION,1,INDEX(PROVERSION,".") + 1)) >= 10.1 AND PROVERSION >= "10.1B" &THEN
     1662       where _connect-id = _userTableStat-conn + 1
     1663   &ENDIF
     1664       no-error.
     1665   
     1666     if _connect-usr = ? then return.
     1667   
     1668     find tt_utable exclusive-lock where tt_utable.xid = p_tbl no-error.
     1669   
     1670     if not available tt_utable then
     1671       do:
     1672         create tt_utable.
     1673         assign
     1674           tt_utable.xid      = p_tbl
     1675           tt_utable.xvalid   = yes
     1676           tt_utable.tblName  =
     1677   &IF DECIMAL(SUBSTRING(PROVERSION,1,INDEX(PROVERSION,".") + 1)) >= 10.1 AND PROVERSION >= "10.1B" &THEN
     1678            ( if available( _userTableStat ) then "" else "*" ) + 
     1679   &ENDIF
     1680             tt_tbl.tblname
     1681           tt_utable.tblNum   = tt_tbl.xid
     1682           tt_utable.areanum  = tt_tbl.areanum
     1683         .
     1684   &IF DECIMAL(SUBSTRING(PROVERSION,1,INDEX(PROVERSION,".") + 1)) >= 10.1 AND PROVERSION >= "10.1B" &THEN
     1685         if available _userTableStat then          /* _userTableStat range may not be active...    */
     1686           do:
     1687             assign
     1688               
     1689   /*******************************************************************************
     1690    *******************************************************************************
     1691    **                                                                           **
     1692    **                                                                           **
     1693    **  Copyright 2003-2006 Tom Bascom, Greenfield Technologies                  **
     1694    **  http://www.greenfieldtech.com                                            **
     1695    **                                                                           **
     1696    **  ProTop is free software; you can redistribute it and/or modify it        **
     1697    **  under the terms of the GNU General Public License (GPL) as published     **
     1698    **  by the Free Software Foundation; either version 2 of the License, or     **
     1699    **  at your option) any later version.                                       **
     1700    **                                                                           **
     1701    **  ProTop is distributed in the hope that it will be useful, but WITHOUT    **
     1702    **  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or    **
     1703    **  FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License     **
     1704    **  for more details.                                                        **
     1705    **                                                                           **
     1706    **  See TERMS.TXT for more information regarding the Terms and Conditions    **
     1707    **  of use and alternative licensing options for this software.              **
     1708    **                                                                           **
     1709    **  A copy of the GPL is in GPL.TXT which was provided with this package.    **
     1710    **                                                                           **
     1711    **  See http://www.fsf.org for more information about the GPL.               **
     1712    **                                                                           **
     1713    **                                                                           **
     1714    *******************************************************************************
     1715    *******************************************************************************
     1716    *
     1717    * init-xrec.i
     1718    *
     1719    * {1} = base field
     1720    * {2} = value to initialze array with
     1721    *
     1722    * [1] = base
     1723    * [2] = last (previous cumulative value)
     1724    * [3] = this
     1725    * [4] = cumulative
     1726    * [5] = interval
     1727    *
     1728    */
     1729   
     1730   tt_utable.tbl-cre[1] = _userTableStat-create
     1731   tt_utable.tbl-cre[2] = _userTableStat-create
     1732   tt_utable.tbl-cre[3] = _userTableStat-create
     1733    
     1734               
     1735   /*******************************************************************************
     1736    *******************************************************************************
     1737    **                                                                           **
     1738    **                                                                           **
     1739    **  Copyright 2003-2006 Tom Bascom, Greenfield Technologies                  **
     1740    **  http://www.greenfieldtech.com                                            **
     1741    **                                                                           **
     1742    **  ProTop is free software; you can redistribute it and/or modify it        **
     1743    **  under the terms of the GNU General Public License (GPL) as published     **
     1744    **  by the Free Software Foundation; either version 2 of the License, or     **
     1745    **  at your option) any later version.                                       **
     1746    **                                                                           **
     1747    **  ProTop is distributed in the hope that it will be useful, but WITHOUT    **
     1748    **  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or    **
     1749    **  FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License     **
     1750    **  for more details.                                                        **
     1751    **                                                                           **
     1752    **  See TERMS.TXT for more information regarding the Terms and Conditions    **
     1753    **  of use and alternative licensing options for this software.              **
     1754    **                                                                           **
     1755    **  A copy of the GPL is in GPL.TXT which was provided with this package.    **
     1756    **                                                                           **
     1757    **  See http://www.fsf.org for more information about the GPL.               **
     1758    **                                                                           **
     1759    **                                                                           **
     1760    *******************************************************************************
     1761    *******************************************************************************
     1762    *
     1763    * init-xrec.i
     1764    *
     1765    * {1} = base field
     1766    * {2} = value to initialze array with
     1767    *
     1768    * [1] = base
     1769    * [2] = last (previous cumulative value)
     1770    * [3] = this
     1771    * [4] = cumulative
     1772    * [5] = interval
     1773    *
     1774    */
     1775   
     1776   tt_utable.tbl-rd[1] = _userTableStat-read
     1777   tt_utable.tbl-rd[2] = _userTableStat-read
     1778   tt_utable.tbl-rd[3] = _userTableStat-read
     1779    
     1780               
     1781   /*******************************************************************************
     1782    *******************************************************************************
     1783    **                                                                           **
     1784    **                                                                           **
     1785    **  Copyright 2003-2006 Tom Bascom, Greenfield Technologies                  **
     1786    **  http://www.greenfieldtech.com                                            **
     1787    **                                                                           **
     1788    **  ProTop is free software; you can redistribute it and/or modify it        **
     1789    **  under the terms of the GNU General Public License (GPL) as published     **
     1790    **  by the Free Software Foundation; either version 2 of the License, or     **
     1791    **  at your option) any later version.                                       **
     1792    **                                                                           **
     1793    **  ProTop is distributed in the hope that it will be useful, but WITHOUT    **
     1794    **  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or    **
     1795    **  FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License     **
     1796    **  for more details.                                                        **
     1797    **                                                                           **
     1798    **  See TERMS.TXT for more information regarding the Terms and Conditions    **
     1799    **  of use and alternative licensing options for this software.              **
     1800    **                                                                           **
     1801    **  A copy of the GPL is in GPL.TXT which was provided with this package.    **
     1802    **                                                                           **
     1803    **  See http://www.fsf.org for more information about the GPL.               **
     1804    **                                                                           **
     1805    **                                                                           **
     1806    *******************************************************************************
     1807    *******************************************************************************
     1808    *
     1809    * init-xrec.i
     1810    *
     1811    * {1} = base field
     1812    * {2} = value to initialze array with
     1813    *
     1814    * [1] = base
     1815    * [2] = last (previous cumulative value)
     1816    * [3] = this
     1817    * [4] = cumulative
     1818    * [5] = interval
     1819    *
     1820    */
     1821   
     1822   tt_utable.tbl-upd[1] = _userTableStat-update
     1823   tt_utable.tbl-upd[2] = _userTableStat-update
     1824   tt_utable.tbl-upd[3] = _userTableStat-update
     1825    
     1826               
     1827   /*******************************************************************************
     1828    *******************************************************************************
     1829    **                                                                           **
     1830    **                                                                           **
     1831    **  Copyright 2003-2006 Tom Bascom, Greenfield Technologies                  **
     1832    **  http://www.greenfieldtech.com                                            **
     1833    **                                                                           **
     1834    **  ProTop is free software; you can redistribute it and/or modify it        **
     1835    **  under the terms of the GNU General Public License (GPL) as published     **
     1836    **  by the Free Software Foundation; either version 2 of the License, or     **
     1837    **  at your option) any later version.                                       **
     1838    **                                                                           **
     1839    **  ProTop is distributed in the hope that it will be useful, but WITHOUT    **
     1840    **  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or    **
     1841    **  FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License     **
     1842    **  for more details.                                                        **
     1843    **                                                                           **
     1844    **  See TERMS.TXT for more information regarding the Terms and Conditions    **
     1845    **  of use and alternative licensing options for this software.              **
     1846    **                                                                           **
     1847    **  A copy of the GPL is in GPL.TXT which was provided with this package.    **
     1848    **                                                                           **
     1849    **  See http://www.fsf.org for more information about the GPL.               **
     1850    **                                                                           **
     1851    **                                                                           **
     1852    *******************************************************************************
     1853    *******************************************************************************
     1854    *
     1855    * init-xrec.i
     1856    *
     1857    * {1} = base field
     1858    * {2} = value to initialze array with
     1859    *
     1860    * [1] = base
     1861    * [2] = last (previous cumulative value)
     1862    * [3] = this
     1863    * [4] = cumulative
     1864    * [5] = interval
     1865    *
     1866    */
     1867   
     1868   tt_utable.tbl-del[1] = _userTableStat-delete
     1869   tt_utable.tbl-del[2] = _userTableStat-delete
     1870   tt_utable.tbl-del[3] = _userTableStat-delete
     1871    
     1872             .
     1873             if hasOSRd = no then
     1874               tt_utable.tbl-osrd = ?.
     1875              else
     1876               assign
     1877                 bh = buffer _userTableStat:handle
     1878                 bf = bh:buffer-field( "_userTableStat-OSRead" )
     1879                 
     1880   /*******************************************************************************
     1881    *******************************************************************************
     1882    **                                                                           **
     1883    **                                                                           **
     1884    **  Copyright 2003-2006 Tom Bascom, Greenfield Technologies                  **
     1885    **  http://www.greenfieldtech.com                                            **
     1886    **                                                                           **
     1887    **  ProTop is free software; you can redistribute it and/or modify it        **
     1888    **  under the terms of the GNU General Public License (GPL) as published     **
     1889    **  by the Free Software Foundation; either version 2 of the License, or     **
     1890    **  at your option) any later version.                                       **
     1891    **                                                                           **
     1892    **  ProTop is distributed in the hope that it will be useful, but WITHOUT    **
     1893    **  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or    **
     1894    **  FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License     **
     1895    **  for more details.                                                        **
     1896    **                                                                           **
     1897    **  See TERMS.TXT for more information regarding the Terms and Conditions    **
     1898    **  of use and alternative licensing options for this software.              **
     1899    **                                                                           **
     1900    **  A copy of the GPL is in GPL.TXT which was provided with this package.    **
     1901    **                                                                           **
     1902    **  See http://www.fsf.org for more information about the GPL.               **
     1903    **                                                                           **
     1904    **                                                                           **
     1905    *******************************************************************************
     1906    *******************************************************************************
     1907    *
     1908    * init-xrec.i
     1909    *
     1910    * {1} = base field
     1911    * {2} = value to initialze array with
     1912    *
     1913    * [1] = base
     1914    * [2] = last (previous cumulative value)
     1915    * [3] = this
     1916    * [4] = cumulative
     1917    * [5] = interval
     1918    *
     1919    */
     1920   
     1921   tt_utable.tbl-osrd[1] = bf:buffer-value
     1922   tt_utable.tbl-osrd[2] = bf:buffer-value
     1923   tt_utable.tbl-osrd[3] = bf:buffer-value
     1924    
     1925               .
     1926           end.
     1927   &ENDIF
     1928       end.
     1929   
     1930     assign
     1931       tt_utable.xvalid   = yes
     1932       tt_utable.usrNum   = _connect-usr
     1933       tt_utable.usrName  = _connect-name
     1934   &IF DECIMAL(SUBSTRING(PROVERSION,1,INDEX(PROVERSION,".") + 1)) >= 10.1 AND PROVERSION >= "10.1B" &THEN
     1935       
     1936   /*******************************************************************************
     1937    *******************************************************************************
     1938    **                                                                           **
     1939    **                                                                           **
     1940    **  Copyright 2003-2006 Tom Bascom, Greenfield Technologies                  **
     1941    **  http://www.greenfieldtech.com                                            **
     1942    **                                                                           **
     1943    **  ProTop is free software; you can redistribute it and/or modify it        **
     1944    **  under the terms of the GNU General Public License (GPL) as published     **
     1945    **  by the Free Software Foundation; either version 2 of the License, or     **
     1946    **  at your option) any later version.                                       **
     1947    **                                                                           **
     1948    **  ProTop is distributed in the hope that it will be useful, but WITHOUT    **
     1949    **  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or    **
     1950    **  FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License     **
     1951    **  for more details.                                                        **
     1952    **                                                                           **
     1953    **  See TERMS.TXT for more information regarding the Terms and Conditions    **
     1954    **  of use and alternative licensing options for this software.              **
     1955    **                                                                           **
     1956    **  A copy of the GPL is in GPL.TXT which was provided with this package.    **
     1957    **                                                                           **
     1958    **  See http://www.fsf.org for more information about the GPL.               **
     1959    **                                                                           **
     1960    **                                                                           **
     1961    *******************************************************************************
     1962    *******************************************************************************
     1963    *
     1964    * upd-xrec.i
     1965    *
     1966    * {1} = base field
     1967    * {2} = value to update metrics with
     1968    *
     1969    * [1] = base
     1970    * [2] = last (previous cumulative value)
     1971    * [3] = this
     1972    * [4] = cumulative
     1973    * [5] = interval
     1974    *
     1975    */
     1976   
     1977   tt_utable.tbl-cre[3] = _userTableStat-create
     1978   tt_utable.tbl-cre[4] = tt_utable.tbl-cre[3] - tt_utable.tbl-cre[1]
     1979   tt_utable.tbl-cre[5] = tt_utable.tbl-cre[3] - tt_utable.tbl-cre[2]
     1980   tt_utable.tbl-cre[2] = tt_utable.tbl-cre[3]
     1981    
     1982       
     1983   /*******************************************************************************
     1984    *******************************************************************************
     1985    **                                                                           **
     1986    **                                                                           **
     1987    **  Copyright 2003-2006 Tom Bascom, Greenfield Technologies                  **
     1988    **  http://www.greenfieldtech.com                                            **
     1989    **                                                                           **
     1990    **  ProTop is free software; you can redistribute it and/or modify it        **
     1991    **  under the terms of the GNU General Public License (GPL) as published     **
     1992    **  by the Free Software Foundation; either version 2 of the License, or     **
     1993    **  at your option) any later version.                                       **
     1994    **                                                                           **
     1995    **  ProTop is distributed in the hope that it will be useful, but WITHOUT    **
     1996    **  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or    **
     1997    **  FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License     **
     1998    **  for more details.                                                        **
     1999    **                                                                           **
     2000    **  See TERMS.TXT for more information regarding the Terms and Conditions    **
     2001    **  of use and alternative licensing options for this software.              **
     2002    **                                                                           **
     2003    **  A copy of the GPL is in GPL.TXT which was provided with this package.    **
     2004    **                                                                           **
     2005    **  See http://www.fsf.org for more information about the GPL.               **
     2006    **                                                                           **
     2007    **                                                                           **
     2008    *******************************************************************************
     2009    *******************************************************************************
     2010    *
     2011    * upd-xrec.i
     2012    *
     2013    * {1} = base field
     2014    * {2} = value to update metrics with
     2015    *
     2016    * [1] = base
     2017    * [2] = last (previous cumulative value)
     2018    * [3] = this
     2019    * [4] = cumulative
     2020    * [5] = interval
     2021    *
     2022    */
     2023   
     2024   tt_utable.tbl-rd[3] = _userTableStat-read
     2025   tt_utable.tbl-rd[4] = tt_utable.tbl-rd[3] - tt_utable.tbl-rd[1]
     2026   tt_utable.tbl-rd[5] = tt_utable.tbl-rd[3] - tt_utable.tbl-rd[2]
     2027   tt_utable.tbl-rd[2] = tt_utable.tbl-rd[3]
     2028    
     2029       
     2030   /*******************************************************************************
     2031    *******************************************************************************
     2032    **                                                                           **
     2033    **                                                                           **
     2034    **  Copyright 2003-2006 Tom Bascom, Greenfield Technologies                  **
     2035    **  http://www.greenfieldtech.com                                            **
     2036    **                                                                           **
     2037    **  ProTop is free software; you can redistribute it and/or modify it        **
     2038    **  under the terms of the GNU General Public License (GPL) as published     **
     2039    **  by the Free Software Foundation; either version 2 of the License, or     **
     2040    **  at your option) any later version.                                       **
     2041    **                                                                           **
     2042    **  ProTop is distributed in the hope that it will be useful, but WITHOUT    **
     2043    **  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or    **
     2044    **  FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License     **
     2045    **  for more details.                                                        **
     2046    **                                                                           **
     2047    **  See TERMS.TXT for more information regarding the Terms and Conditions    **
     2048    **  of use and alternative licensing options for this software.              **
     2049    **                                                                           **
     2050    **  A copy of the GPL is in GPL.TXT which was provided with this package.    **
     2051    **                                                                           **
     2052    **  See http://www.fsf.org for more information about the GPL.               **
     2053    **                                                                           **
     2054    **                                                                           **
     2055    *******************************************************************************
     2056    *******************************************************************************
     2057    *
     2058    * upd-xrec.i
     2059    *
     2060    * {1} = base field
     2061    * {2} = value to update metrics with
     2062    *
     2063    * [1] = base
     2064    * [2] = last (previous cumulative value)
     2065    * [3] = this
     2066    * [4] = cumulative
     2067    * [5] = interval
     2068    *
     2069    */
     2070   
     2071   tt_utable.tbl-upd[3] = _userTableStat-update
     2072   tt_utable.tbl-upd[4] = tt_utable.tbl-upd[3] - tt_utable.tbl-upd[1]
     2073   tt_utable.tbl-upd[5] = tt_utable.tbl-upd[3] - tt_utable.tbl-upd[2]
     2074   tt_utable.tbl-upd[2] = tt_utable.tbl-upd[3]
     2075    
     2076       
     2077   /*******************************************************************************
     2078    *******************************************************************************
     2079    **                                                                           **
     2080    **                                                                           **
     2081    **  Copyright 2003-2006 Tom Bascom, Greenfield Technologies                  **
     2082    **  http://www.greenfieldtech.com                                            **
     2083    **                                                                           **
     2084    **  ProTop is free software; you can redistribute it and/or modify it        **
     2085    **  under the terms of the GNU General Public License (GPL) as published     **
     2086    **  by the Free Software Foundation; either version 2 of the License, or     **
     2087    **  at your option) any later version.                                       **
     2088    **                                                                           **
     2089    **  ProTop is distributed in the hope that it will be useful, but WITHOUT    **
     2090    **  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or    **
     2091    **  FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License     **
     2092    **  for more details.                                                        **
     2093    **                                                                           **
     2094    **  See TERMS.TXT for more information regarding the Terms and Conditions    **
     2095    **  of use and alternative licensing options for this software.              **
     2096    **                                                                           **
     2097    **  A copy of the GPL is in GPL.TXT which was provided with this package.    **
     2098    **                                                                           **
     2099    **  See http://www.fsf.org for more information about the GPL.               **
     2100    **                                                                           **
     2101    **                                                                           **
     2102    *******************************************************************************
     2103    *******************************************************************************
     2104    *
     2105    * upd-xrec.i
     2106    *
     2107    * {1} = base field
     2108    * {2} = value to update metrics with
     2109    *
     2110    * [1] = base
     2111    * [2] = last (previous cumulative value)
     2112    * [3] = this
     2113    * [4] = cumulative
     2114    * [5] = interval
     2115    *
     2116    */
     2117   
     2118   tt_utable.tbl-del[3] = _userTableStat-delete
     2119   tt_utable.tbl-del[4] = tt_utable.tbl-del[3] - tt_utable.tbl-del[1]
     2120   tt_utable.tbl-del[5] = tt_utable.tbl-del[3] - tt_utable.tbl-del[2]
     2121   tt_utable.tbl-del[2] = tt_utable.tbl-del[3]
     2122    
     2123     .
     2124     if hasOSRd then
     2125       assign
     2126         bh = buffer _userTableStat:handle
     2127         bf = bh:buffer-field( "_userTableStat-OSRead" )
     2128         
     2129   /*******************************************************************************
     2130    *******************************************************************************
     2131    **                                                                           **
     2132    **                                                                           **
     2133    **  Copyright 2003-2006 Tom Bascom, Greenfield Technologies                  **
     2134    **  http://www.greenfieldtech.com                                            **
     2135    **                                                                           **
     2136    **  ProTop is free software; you can redistribute it and/or modify it        **
     2137    **  under the terms of the GNU General Public License (GPL) as published     **
     2138    **  by the Free Software Foundation; either version 2 of the License, or     **
     2139    **  at your option) any later version.                                       **
     2140    **                                                                           **
     2141    **  ProTop is distributed in the hope that it will be useful, but WITHOUT    **
     2142    **  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or    **
     2143    **  FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License     **
     2144    **  for more details.                                                        **
     2145    **                                                                           **
     2146    **  See TERMS.TXT for more information regarding the Terms and Conditions    **
     2147    **  of use and alternative licensing options for this software.              **
     2148    **                                                                           **
     2149    **  A copy of the GPL is in GPL.TXT which was provided with this package.    **
     2150    **                                                                           **
     2151    **  See http://www.fsf.org for more information about the GPL.               **
     2152    **                                                                           **
     2153    **                                                                           **
     2154    *******************************************************************************
     2155    *******************************************************************************
     2156    *
     2157    * upd-xrec.i
     2158    *
     2159    * {1} = base field
     2160    * {2} = value to update metrics with
     2161    *
     2162    * [1] = base
     2163    * [2] = last (previous cumulative value)
     2164    * [3] = this
     2165    * [4] = cumulative
     2166    * [5] = interval
     2167    *
     2168    */
     2169   
     2170   tt_utable.tbl-osrd[3] = bf:buffer-value
     2171   tt_utable.tbl-osrd[4] = tt_utable.tbl-osrd[3] - tt_utable.tbl-osrd[1]
     2172   tt_utable.tbl-osrd[5] = tt_utable.tbl-osrd[3] - tt_utable.tbl-osrd[2]
     2173   tt_utable.tbl-osrd[2] = tt_utable.tbl-osrd[3]
     2174    
     2175   &ENDIF
     2176       .
     2177   
     2178     /* This uses the *base* statistics rather than the sampled data -- so it reveals
     2179      * the historical pattern rather than current usage.
     2180      */
     2181   
     2182     if ( tt_utable.tbl-cre[x] > 10 and tt_utable.tbl-del[x] > 10 ) and
     2183        ( abs( tt_utable.tbl-cre[x] - tt_utable.tbl-del[x] ) < ( tt_utable.tbl-cre[x] * 0.2 )) then
     2184       tt_utable.ttbl = "***".
     2185      else
     2186       tt_utable.ttbl = "".
     2187   
     2188     return.
     2189   
     2190   end.
     2191   
     2192   /* this will be called by the including procedure's mon-update procedure
     2193    *
     2194    */
     2195   
     2196   procedure age_utable:
     2197   
     2198     for each tt_utable exclusive-lock:
     2199   
     2200       if tt_utable.xvalid = no then
     2201         delete tt_utable.
     2202        else
     2203         assign
     2204           tt_utable.xvalid = no
     2205         .
     2206   
     2207     end.
     2208   
     2209     return.
     2210   
     2211   end.
     2212    
     2213   
     2214   /*******************************************************************************
     2215    *******************************************************************************
     2216    **                                                                           **
     2217    **                                                                           **
     2218    **  Copyright 2003-2006 Tom Bascom, Greenfield Technologies                  **
     2219    **  http://www.greenfieldtech.com                                            **
     2220    **                                                                           **
     2221    **  ProTop is free software; you can redistribute it and/or modify it        **
     2222    **  under the terms of the GNU General Public License (GPL) as published     **
     2223    **  by the Free Software Foundation; either version 2 of the License, or     **
     2224    **  at your option) any later version.                                       **
     2225    **                                                                           **
     2226    **  ProTop is distributed in the hope that it will be useful, but WITHOUT    **
     2227    **  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or    **
     2228    **  FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License     **
     2229    **  for more details.                                                        **
     2230    **                                                                           **
     2231    **  See TERMS.TXT for more information regarding the Terms and Conditions    **
     2232    **  of use and alternative licensing options for this software.              **
     2233    **                                                                           **
     2234    **  A copy of the GPL is in GPL.TXT which was provided with this package.    **
     2235    **                                                                           **
     2236    **  See http://www.fsf.org for more information about the GPL.               **
     2237    **                                                                           **
     2238    **                                                                           **
     2239    *******************************************************************************
     2240    *******************************************************************************
     2241    *
     2242    * tt_uindex.i
     2243    *
     2244    */
     2245   
     2246   define temp-table tt_uindex no-undo
     2247     field xid        as integer
     2248     field xvalid     as logical
     2249     field idxNum     as integer
     2250     field idxName    as character
     2251     field tblName    as character
     2252     field areaNum    as integer
     2253     field idxRoot    as int64
     2254     field idxnote    as character
     2255     field usrNum     as integer
     2256     field usrName    as character
     2257     field idx-cre    as decimal extent 5
     2258     field idx-rd     as decimal extent 5
     2259     field idx-split  as decimal extent 5
     2260     field idx-del    as decimal extent 5
     2261     field idx-blkdel as decimal extent 5
     2262     index xid-idx is unique primary xid.
     2263   
     2264   define variable iBase   as integer no-undo.
     2265   define variable iRange  as integer no-undo.
     2266   define variable iUsed   as integer no-undo.
     2267   
     2268   iBase = recid( _indexStat ).
     2269   find last  dictDB._indexStat no-lock.
     2270   iRange  = recid( _indexStat ).
     2271   
     2272   iUsed = 0.
     2273   for each dictDB._index no-lock:
     2274     iUsed = iUsed + 1.
     2275   end.
     2276   
     2277   procedure upd-tt_uindex:
     2278   
     2279     define input parameter p_idx as integer no-undo.
     2280   
     2281     define variable x as integer no-undo.
     2282     define variable z as integer no-undo.
     2283   
     2284     do-SumSample( output x, output z ).
     2285   
     2286   &IF DECIMAL(SUBSTRING(PROVERSION,1,INDEX(PROVERSION,".") + 1)) >= 10.1 AND PROVERSION >= "10.1B" &THEN
     2287     find dictdb._userIndexStat no-lock where _userIndexStat-id = p_idx no-error.
     2288     find tt_idx no-lock where tt_idx.xid = _userIndexStat-num no-error.
     2289   &ENDIF
     2290   
     2291     if not available tt_idx then return.
     2292   
     2293     find dictdb._connect no-lock
     2294   &IF DECIMAL(SUBSTRING(PROVERSION,1,INDEX(PROVERSION,".") + 1)) >= 10.1 AND PROVERSION >= "10.1B" &THEN
     2295       where _connect-id = _userIndexStat-conn + 1
     2296   &ENDIF
     2297       no-error.
     2298   
     2299     if _connect-usr = ? then return.  /* it might be a good idea to zero out any existing tt_uindex 1st... */
     2300   
     2301     find tt_uindex exclusive-lock where tt_uindex.xid = p_idx no-error.
     2302   
     2303     if not available tt_uindex then
     2304       do:
     2305         create tt_uindex.
     2306         assign
     2307           tt_uindex.xid      = p_idx
     2308           tt_uindex.xvalid   = yes
     2309   &IF DECIMAL(SUBSTRING(PROVERSION,1,INDEX(PROVERSION,".") + 1)) >= 10.1 AND PROVERSION >= "10.1B" &THEN
     2310           tt_uindex.idxName  = ( if available( _userIndexStat ) then "" else "*" ) + tt_idx.tblname + "." + tt_idx.idxname
     2311   &ENDIF
     2312           tt_uindex.idxnote  = tt_idx.idxnote
     2313           tt_uindex.idxNum   = tt_idx.xid
     2314           tt_uindex.idxroot  = tt_idx.idxroot
     2315           tt_uindex.areanum  = tt_idx.areanum
     2316         .
     2317   &IF DECIMAL(SUBSTRING(PROVERSION,1,INDEX(PROVERSION,".") + 1)) >= 10.1 AND PROVERSION >= "10.1B" &THEN
     2318         if available _userIndexStat then          /* _userIndexStat range may not be active...    */
     2319           assign
     2320             
     2321   /*******************************************************************************
     2322    *******************************************************************************
     2323    **                                                                           **
     2324    **                                                                           **
     2325    **  Copyright 2003-2006 Tom Bascom, Greenfield Technologies                  **
     2326    **  http://www.greenfieldtech.com                                            **
     2327    **                                                                           **
     2328    **  ProTop is free software; you can redistribute it and/or modify it        **
     2329    **  under the terms of the GNU General Public License (GPL) as published     **
     2330    **  by the Free Software Foundation; either version 2 of the License, or     **
     2331    **  at your option) any later version.                                       **
     2332    **                                                                           **
     2333    **  ProTop is distributed in the hope that it will be useful, but WITHOUT    **
     2334    **  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or    **
     2335    **  FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License     **
     2336    **  for more details.                                                        **
     2337    **                                                                           **
     2338    **  See TERMS.TXT for more information regarding the Terms and Conditions    **
     2339    **  of use and alternative licensing options for this software.              **
     2340    **                                                                           **
     2341    **  A copy of the GPL is in GPL.TXT which was provided with this package.    **
     2342    **                                                                           **
     2343    **  See http://www.fsf.org for more information about the GPL.               **
     2344    **                                                                           **
     2345    **                                                                           **
     2346    *******************************************************************************
     2347    *******************************************************************************
     2348    *
     2349    * init-xrec.i
     2350    *
     2351    * {1} = base field
     2352    * {2} = value to initialze array with
     2353    *
     2354    * [1] = base
     2355    * [2] = last (previous cumulative value)
     2356    * [3] = this
     2357    * [4] = cumulative
     2358    * [5] = interval
     2359    *
     2360    */
     2361   
     2362   tt_uindex.idx-cre[1] = _userIndexStat-create
     2363   tt_uindex.idx-cre[2] = _userIndexStat-create
     2364   tt_uindex.idx-cre[3] = _userIndexStat-create
     2365    
     2366             
     2367   /*******************************************************************************
     2368    *******************************************************************************
     2369    **                                                                           **
     2370    **                                                                           **
     2371    **  Copyright 2003-2006 Tom Bascom, Greenfield Technologies                  **
     2372    **  http://www.greenfieldtech.com                                            **
     2373    **                                                                           **
     2374    **  ProTop is free software; you can redistribute it and/or modify it        **
     2375    **  under the terms of the GNU General Public License (GPL) as published     **
     2376    **  by the Free Software Foundation; either version 2 of the License, or     **
     2377    **  at your option) any later version.                                       **
     2378    **                                                                           **
     2379    **  ProTop is distributed in the hope that it will be useful, but WITHOUT    **
     2380    **  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or    **
     2381    **  FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License     **
     2382    **  for more details.                                                        **
     2383    **                                                                           **
     2384    **  See TERMS.TXT for more information regarding the Terms and Conditions    **
     2385    **  of use and alternative licensing options for this software.              **
     2386    **                                                                           **
     2387    **  A copy of the GPL is in GPL.TXT which was provided with this package.    **
     2388    **                                                                           **
     2389    **  See http://www.fsf.org for more information about the GPL.               **
     2390    **                                                                           **
     2391    **                                                                           **
     2392    *******************************************************************************
     2393    *******************************************************************************
     2394    *
     2395    * init-xrec.i
     2396    *
     2397    * {1} = base field
     2398    * {2} = value to initialze array with
     2399    *
     2400    * [1] = base
     2401    * [2] = last (previous cumulative value)
     2402    * [3] = this
     2403    * [4] = cumulative
     2404    * [5] = interval
     2405    *
     2406    */
     2407   
     2408   tt_uindex.idx-rd[1] = _userIndexStat-read
     2409   tt_uindex.idx-rd[2] = _userIndexStat-read
     2410   tt_uindex.idx-rd[3] = _userIndexStat-read
     2411    
     2412             
     2413   /*******************************************************************************
     2414    *******************************************************************************
     2415    **                                                                           **
     2416    **                                                                           **
     2417    **  Copyright 2003-2006 Tom Bascom, Greenfield Technologies                  **
     2418    **  http://www.greenfieldtech.com                                            **
     2419    **                                                                           **
     2420    **  ProTop is free software; you can redistribute it and/or modify it        **
     2421    **  under the terms of the GNU General Public License (GPL) as published     **
     2422    **  by the Free Software Foundation; either version 2 of the License, or     **
     2423    **  at your option) any later version.                                       **
     2424    **                                                                           **
     2425    **  ProTop is distributed in the hope that it will be useful, but WITHOUT    **
     2426    **  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or    **
     2427    **  FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License     **
     2428    **  for more details.                                                        **
     2429    **                                                                           **
     2430    **  See TERMS.TXT for more information regarding the Terms and Conditions    **
     2431    **  of use and alternative licensing options for this software.              **
     2432    **                                                                           **
     2433    **  A copy of the GPL is in GPL.TXT which was provided with this package.    **
     2434    **                                                                           **
     2435    **  See http://www.fsf.org for more information about the GPL.               **
     2436    **                                                                           **
     2437    **                                                                           **
     2438    *******************************************************************************
     2439    *******************************************************************************
     2440    *
     2441    * init-xrec.i
     2442    *
     2443    * {1} = base field
     2444    * {2} = value to initialze array with
     2445    *
     2446    * [1] = base
     2447    * [2] = last (previous cumulative value)
     2448    * [3] = this
     2449    * [4] = cumulative
     2450    * [5] = interval
     2451    *
     2452    */
     2453   
     2454   tt_uindex.idx-split[1] = _userIndexStat-split
     2455   tt_uindex.idx-split[2] = _userIndexStat-split
     2456   tt_uindex.idx-split[3] = _userIndexStat-split
     2457    
     2458             
     2459   /*******************************************************************************
     2460    *******************************************************************************
     2461    **                                                                           **
     2462    **                                                                           **
     2463    **  Copyright 2003-2006 Tom Bascom, Greenfield Technologies                  **
     2464    **  http://www.greenfieldtech.com                                            **
     2465    **                                                                           **
     2466    **  ProTop is free software; you can redistribute it and/or modify it        **
     2467    **  under the terms of the GNU General Public License (GPL) as published     **
     2468    **  by the Free Software Foundation; either version 2 of the License, or     **
     2469    **  at your option) any later version.                                       **
     2470    **                                                                           **
     2471    **  ProTop is distributed in the hope that it will be useful, but WITHOUT    **
     2472    **  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or    **
     2473    **  FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License     **
     2474    **  for more details.                                                        **
     2475    **                                                                           **
     2476    **  See TERMS.TXT for more information regarding the Terms and Conditions    **
     2477    **  of use and alternative licensing options for this software.              **
     2478    **                                                                           **
     2479    **  A copy of the GPL is in GPL.TXT which was provided with this package.    **
     2480    **                                                                           **
     2481    **  See http://www.fsf.org for more information about the GPL.               **
     2482    **                                                                           **
     2483    **                                                                           **
     2484    *******************************************************************************
     2485    *******************************************************************************
     2486    *
     2487    * init-xrec.i
     2488    *
     2489    * {1} = base field
     2490    * {2} = value to initialze array with
     2491    *
     2492    * [1] = base
     2493    * [2] = last (previous cumulative value)
     2494    * [3] = this
     2495    * [4] = cumulative
     2496    * [5] = interval
     2497    *
     2498    */
     2499   
     2500   tt_uindex.idx-del[1] = _userIndexStat-delete
     2501   tt_uindex.idx-del[2] = _userIndexStat-delete
     2502   tt_uindex.idx-del[3] = _userIndexStat-delete
     2503    
     2504             
     2505   /*******************************************************************************
     2506    *******************************************************************************
     2507    **                                                                           **
     2508    **                                                                           **
     2509    **  Copyright 2003-2006 Tom Bascom, Greenfield Technologies                  **
     2510    **  http://www.greenfieldtech.com                                            **
     2511    **                                                                           **
     2512    **  ProTop is free software; you can redistribute it and/or modify it        **
     2513    **  under the terms of the GNU General Public License (GPL) as published     **
     2514    **  by the Free Software Foundation; either version 2 of the License, or     **
     2515    **  at your option) any later version.                                       **
     2516    **                                                                           **
     2517    **  ProTop is distributed in the hope that it will be useful, but WITHOUT    **
     2518    **  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or    **
     2519    **  FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License     **
     2520    **  for more details.                                                        **
     2521    **                                                                           **
     2522    **  See TERMS.TXT for more information regarding the Terms and Conditions    **
     2523    **  of use and alternative licensing options for this software.              **
     2524    **                                                                           **
     2525    **  A copy of the GPL is in GPL.TXT which was provided with this package.    **
     2526    **                                                                           **
     2527    **  See http://www.fsf.org for more information about the GPL.               **
     2528    **                                                                           **
     2529    **                                                                           **
     2530    *******************************************************************************
     2531    *******************************************************************************
     2532    *
     2533    * init-xrec.i
     2534    *
     2535    * {1} = base field
     2536    * {2} = value to initialze array with
     2537    *
     2538    * [1] = base
     2539    * [2] = last (previous cumulative value)
     2540    * [3] = this
     2541    * [4] = cumulative
     2542    * [5] = interval
     2543    *
     2544    */
     2545   
     2546   tt_uindex.idx-blkdel[1] = _userIndexStat-blockdelete
     2547   tt_uindex.idx-blkdel[2] = _userIndexStat-blockdelete
     2548   tt_uindex.idx-blkdel[3] = _userIndexStat-blockdelete
     2549    
     2550           .
     2551   &ENDIF
     2552       end.
     2553   
     2554     assign
     2555       tt_uindex.xvalid   = yes
     2556       tt_uindex.usrNum   = _connect-usr
     2557       tt_uindex.usrName  = _connect-name
     2558   &IF DECIMAL(SUBSTRING(PROVERSION,1,INDEX(PROVERSION,".") + 1)) >= 10.1 AND PROVERSION >= "10.1B" &THEN
     2559       
     2560   /*******************************************************************************
     2561    *******************************************************************************
     2562    **                                                                           **
     2563    **                                                                           **
     2564    **  Copyright 2003-2006 Tom Bascom, Greenfield Technologies                  **
     2565    **  http://www.greenfieldtech.com                                            **
     2566    **                                                                           **
     2567    **  ProTop is free software; you can redistribute it and/or modify it        **
     2568    **  under the terms of the GNU General Public License (GPL) as published     **
     2569    **  by the Free Software Foundation; either version 2 of the License, or     **
     2570    **  at your option) any later version.                                       **
     2571    **                                                                           **
     2572    **  ProTop is distributed in the hope that it will be useful, but WITHOUT    **
     2573    **  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or    **
     2574    **  FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License     **
     2575    **  for more details.                                                        **
     2576    **                                                                           **
     2577    **  See TERMS.TXT for more information regarding the Terms and Conditions    **
     2578    **  of use and alternative licensing options for this software.              **
     2579    **                                                                           **
     2580    **  A copy of the GPL is in GPL.TXT which was provided with this package.    **
     2581    **                                                                           **
     2582    **  See http://www.fsf.org for more information about the GPL.               **
     2583    **                                                                           **
     2584    **                                                                           **
     2585    *******************************************************************************
     2586    *******************************************************************************
     2587    *
     2588    * upd-xrec.i
     2589    *
     2590    * {1} = base field
     2591    * {2} = value to update metrics with
     2592    *
     2593    * [1] = base
     2594    * [2] = last (previous cumulative value)
     2595    * [3] = this
     2596    * [4] = cumulative
     2597    * [5] = interval
     2598    *
     2599    */
     2600   
     2601   tt_uindex.idx-cre[3] = _userIndexStat-create
     2602   tt_uindex.idx-cre[4] = tt_uindex.idx-cre[3] - tt_uindex.idx-cre[1]
     2603   tt_uindex.idx-cre[5] = tt_uindex.idx-cre[3] - tt_uindex.idx-cre[2]
     2604   tt_uindex.idx-cre[2] = tt_uindex.idx-cre[3]
     2605    
     2606       
     2607   /*******************************************************************************
     2608    *******************************************************************************
     2609    **                                                                           **
     2610    **                                                                           **
     2611    **  Copyright 2003-2006 Tom Bascom, Greenfield Technologies                  **
     2612    **  http://www.greenfieldtech.com                                            **
     2613    **                                                                           **
     2614    **  ProTop is free software; you can redistribute it and/or modify it        **
     2615    **  under the terms of the GNU General Public License (GPL) as published     **
     2616    **  by the Free Software Foundation; either version 2 of the License, or     **
     2617    **  at your option) any later version.                                       **
     2618    **                                                                           **
     2619    **  ProTop is distributed in the hope that it will be useful, but WITHOUT    **
     2620    **  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or    **
     2621    **  FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License     **
     2622    **  for more details.                                                        **
     2623    **                                                                           **
     2624    **  See TERMS.TXT for more information regarding the Terms and Conditions    **
     2625    **  of use and alternative licensing options for this software.              **
     2626    **                                                                           **
     2627    **  A copy of the GPL is in GPL.TXT which was provided with this package.    **
     2628    **                                                                           **
     2629    **  See http://www.fsf.org for more information about the GPL.               **
     2630    **                                                                           **
     2631    **                                                                           **
     2632    *******************************************************************************
     2633    *******************************************************************************
     2634    *
     2635    * upd-xrec.i
     2636    *
     2637    * {1} = base field
     2638    * {2} = value to update metrics with
     2639    *
     2640    * [1] = base
     2641    * [2] = last (previous cumulative value)
     2642    * [3] = this
     2643    * [4] = cumulative
     2644    * [5] = interval
     2645    *
     2646    */
     2647   
     2648   tt_uindex.idx-rd[3] = _userIndexStat-read
     2649   tt_uindex.idx-rd[4] = tt_uindex.idx-rd[3] - tt_uindex.idx-rd[1]
     2650   tt_uindex.idx-rd[5] = tt_uindex.idx-rd[3] - tt_uindex.idx-rd[2]
     2651   tt_uindex.idx-rd[2] = tt_uindex.idx-rd[3]
     2652    
     2653       
     2654   /*******************************************************************************
     2655    *******************************************************************************
     2656    **                                                                           **
     2657    **                                                                           **
     2658    **  Copyright 2003-2006 Tom Bascom, Greenfield Technologies                  **
     2659    **  http://www.greenfieldtech.com                                            **
     2660    **                                                                           **
     2661    **  ProTop is free software; you can redistribute it and/or modify it        **
     2662    **  under the terms of the GNU General Public License (GPL) as published     **
     2663    **  by the Free Software Foundation; either version 2 of the License, or     **
     2664    **  at your option) any later version.                                       **
     2665    **                                                                           **
     2666    **  ProTop is distributed in the hope that it will be useful, but WITHOUT    **
     2667    **  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or    **
     2668    **  FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License     **
     2669    **  for more details.                                                        **
     2670    **                                                                           **
     2671    **  See TERMS.TXT for more information regarding the Terms and Conditions    **
     2672    **  of use and alternative licensing options for this software.              **
     2673    **                                                                           **
     2674    **  A copy of the GPL is in GPL.TXT which was provided with this package.    **
     2675    **                                                                           **
     2676    **  See http://www.fsf.org for more information about the GPL.               **
     2677    **                                                                           **
     2678    **                                                                           **
     2679    *******************************************************************************
     2680    *******************************************************************************
     2681    *
     2682    * upd-xrec.i
     2683    *
     2684    * {1} = base field
     2685    * {2} = value to update metrics with
     2686    *
     2687    * [1] = base
     2688    * [2] = last (previous cumulative value)
     2689    * [3] = this
     2690    * [4] = cumulative
     2691    * [5] = interval
     2692    *
     2693    */
     2694   
     2695   tt_uindex.idx-split[3] = _userIndexStat-split
     2696   tt_uindex.idx-split[4] = tt_uindex.idx-split[3] - tt_uindex.idx-split[1]
     2697   tt_uindex.idx-split[5] = tt_uindex.idx-split[3] - tt_uindex.idx-split[2]
     2698   tt_uindex.idx-split[2] = tt_uindex.idx-split[3]
     2699    
     2700       
     2701   /*******************************************************************************
     2702    *******************************************************************************
     2703    **                                                                           **
     2704    **                                                                           **
     2705    **  Copyright 2003-2006 Tom Bascom, Greenfield Technologies                  **
     2706    **  http://www.greenfieldtech.com                                            **
     2707    **                                                                           **
     2708    **  ProTop is free software; you can redistribute it and/or modify it        **
     2709    **  under the terms of the GNU General Public License (GPL) as published     **
     2710    **  by the Free Software Foundation; either version 2 of the License, or     **
     2711    **  at your option) any later version.                                       **
     2712    **                                                                           **
     2713    **  ProTop is distributed in the hope that it will be useful, but WITHOUT    **
     2714    **  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or    **
     2715    **  FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License     **
     2716    **  for more details.                                                        **
     2717    **                                                                           **
     2718    **  See TERMS.TXT for more information regarding the Terms and Conditions    **
     2719    **  of use and alternative licensing options for this software.              **
     2720    **                                                                           **
     2721    **  A copy of the GPL is in GPL.TXT which was provided with this package.    **
     2722    **                                                                           **
     2723    **  See http://www.fsf.org for more information about the GPL.               **
     2724    **                                                                           **
     2725    **                                                                           **
     2726    *******************************************************************************
     2727    *******************************************************************************
     2728    *
     2729    * upd-xrec.i
     2730    *
     2731    * {1} = base field
     2732    * {2} = value to update metrics with
     2733    *
     2734    * [1] = base
     2735    * [2] = last (previous cumulative value)
     2736    * [3] = this
     2737    * [4] = cumulative
     2738    * [5] = interval
     2739    *
     2740    */
     2741   
     2742   tt_uindex.idx-del[3] = _userIndexStat-delete
     2743   tt_uindex.idx-del[4] = tt_uindex.idx-del[3] - tt_uindex.idx-del[1]
     2744   tt_uindex.idx-del[5] = tt_uindex.idx-del[3] - tt_uindex.idx-del[2]
     2745   tt_uindex.idx-del[2] = tt_uindex.idx-del[3]
     2746    
     2747       
     2748   /*******************************************************************************
     2749    *******************************************************************************
     2750    **                                                                           **
     2751    **                                                                           **
     2752    **  Copyright 2003-2006 Tom Bascom, Greenfield Technologies                  **
     2753    **  http://www.greenfieldtech.com                                            **
     2754    **                                                                           **
     2755    **  ProTop is free software; you can redistribute it and/or modify it        **
     2756    **  under the terms of the GNU General Public License (GPL) as published     **
     2757    **  by the Free Software Foundation; either version 2 of the License, or     **
     2758    **  at your option) any later version.                                       **
     2759    **                                                                           **
     2760    **  ProTop is distributed in the hope that it will be useful, but WITHOUT    **
     2761    **  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or    **
     2762    **  FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License     **
     2763    **  for more details.                                                        **
     2764    **                                                                           **
     2765    **  See TERMS.TXT for more information regarding the Terms and Conditions    **
     2766    **  of use and alternative licensing options for this software.              **
     2767    **                                                                           **
     2768    **  A copy of the GPL is in GPL.TXT which was provided with this package.    **
     2769    **                                                                           **
     2770    **  See http://www.fsf.org for more information about the GPL.               **
     2771    **                                                                           **
     2772    **                                                                           **
     2773    *******************************************************************************
     2774    *******************************************************************************
     2775    *
     2776    * upd-xrec.i
     2777    *
     2778    * {1} = base field
     2779    * {2} = value to update metrics with
     2780    *
     2781    * [1] = base
     2782    * [2] = last (previous cumulative value)
     2783    * [3] = this
     2784    * [4] = cumulative
     2785    * [5] = interval
     2786    *
     2787    */
     2788   
     2789   tt_uindex.idx-blkdel[3] = _userIndexStat-blockdelete
     2790   tt_uindex.idx-blkdel[4] = tt_uindex.idx-blkdel[3] - tt_uindex.idx-blkdel[1]
     2791   tt_uindex.idx-blkdel[5] = tt_uindex.idx-blkdel[3] - tt_uindex.idx-blkdel[2]
     2792   tt_uindex.idx-blkdel[2] = tt_uindex.idx-blkdel[3]
     2793    
     2794   &ENDIF
     2795     .
     2796   
     2797     return.
     2798   
     2799   end.
     2800   
     2801   /* this will be called by the including procedure's mon-update procedure
     2802    *
     2803    */
     2804   
     2805   procedure age_uindex:
     2806   
     2807     for each tt_uindex exclusive-lock:
     2808   
     2809       if tt_uindex.xvalid = no then
     2810         delete tt_uindex.
     2811        else
     2812         assign
     2813           tt_uindex.xvalid = no
     2814         .
     2815   
     2816     end.
     2817   
     2818     return.
     2819   
     2820   end.
     2821    
     2822   
     2823   define temp-table tt_sstat no-undo                                      /* tt to sample statistics                      */
     2824     field xId          as integer                                         /* metric id                                    */
     2825     field sum-stat     as decimal extent 5 format ">>>>>>9"               /* init, prev, curr, cumulative & interval      */
     2826     index xid-idx is unique primary xId
     2827   .
     2828   
     2829   define temp-table tt_UserInfo no-undo
     2830     field usrNum      as integer   format ">>>9"
     2831     field usrId       as integer   format ">>>9"
     2832     field usrName     as character format "x(30)"
     2833     field usrFullName as character format "x(30)"
     2834     field usrPhone    as character format "x(30)"
     2835     field usrEMail    as character format "x(30)"
     2836     field usrIPAddr   as character format "x(30)"
     2837     field usrPID      as integer   format ">>>>>>>>9"
     2838     field usrServ     as integer   format ">>>>>>>>>"
     2839     field usrLoginTm  as character format "x(24)"
     2840     field usrDBA      as decimal   format ">>>>>>>>9"
     2841     field usrDBR      as decimal   format ">>>>>>>>9"
     2842     field usrHR       as decimal   format ">>9.99%"
     2843     field usrDBW      as decimal   format ">>>>>>>>9"
     2844     field usrBIRd     as decimal   format ">>>>>>>>9"
     2845     field usrBIWr     as decimal   format ">>>>>>>>9"
     2846     field usrAIRd     as decimal   format ">>>>>>>>9"
     2847     field usrAIWr     as decimal   format ">>>>>>>>9"
     2848     field usrRecLks   as integer   format ">>>>>>>>9"
     2849     field SessionInfo as character format "x(30)"
     2850     field TrxInfo     as character format "x(30)"
     2851   
     2852     index usrNum-idx  is unique primary usrNum
     2853   .
     2854   
     2855   
     2856   /* lib/dumpTT.i
     2857    *
     2858    * simplified to a single line -- include should be eliminated.
     2859    *
     2860    */
     2861   
     2862   &IF DECIMAL(SUBSTRING(PROVERSION,1,INDEX(PROVERSION,".") + 1)) >= 10.1 &THEN
     2863   /*** +++
     2864   file-info:file-name = "./ptdefs".
     2865   if file-info:full-pathname <> ? and index( file-info:file-type, "d" ) > 0 and index( file-info:file-type, "w" ) > 0 then
     2866     do:
     2867   
     2868       file-info:file-name = "./ptdefs/{1}.xsd".
     2869   
     2870       if true /* file-info:full-pathname = ? or file-info:file-size = 0 */ then
     2871         do:
     2872   
     2873           temp-table {1}:write-xmlschema(
     2874             "file",
     2875   /*        substitute( "ptdefs/&1.xsd", "{1}" ), */
     2876   /*        "./ptdefs/{1}.xsd", */
     2877             ( if opsys = "unix" then "./ptdefs/{1}.xsd" else ".~\ptdefs~\{1}.xsd" ),
     2878             true
     2879   
     2880         &IF DECIMAL(SUBSTRING(PROVERSION,1,INDEX(PROVERSION,".") + 1)) >= 10.2
     2881         &THEN
     2882             , ?, ?, ?
     2883         &ENDIF
     2884   
     2885       ).
     2886   
     2887       end.
     2888   
     2889     end.
     2890    +++ ***/
     2891   &ENDIF
     2892    
     2893   
     2894   define temp-table tt_uOther no-undo
     2895     field xid         as integer   format "->>>>9"
     2896     field usrNum      as integer   format ">>>>9"      label "USR#"
     2897     field usrPID      as integer   format ">>>>>>>9"   label "PID"
     2898     field usrType     as character format "x(5)"       label "Flags"
     2899     field usrServ     as integer   format ">>>>>9"     label "Server"
     2900     field usrIPAddr   as character format "x(16)"      label "Device/IP Address"
     2901     field usrLoginTm  as character format "x(15)"      label "Login Time"
     2902   /*
     2903     field usrDBA      as decimal   format ">>>>>>>>9"  label "Blk Access"
     2904     field usrDBR      as decimal   format ">>>>>>>>9"  label "OS Reads"
     2905     field usrDBW      as decimal   format ">>>>>>>>9"  label "OS Writes"
     2906     field usrHR       as decimal   format ">>9.99%"    label "Hit%"
     2907    */
     2908     field lineNum      as integer   format "->>>>9"    label "Line#"
     2909     field procName     as character format "x(86)"     label "Program Name"
     2910   /*
     2911     field IPName       as character format "x(20)"     label "Routine (IP)"
     2912    */
     2913     index usrNum-idx  is unique primary usrNum
     2914     index xid-idx     is unique xid
     2915   .
     2916   
     2917   /*
     2918   define temp-table tt_tblAct no-undo
     2919     field xid        as integer   format "->>>>9"
     2920     field tblNum     as integer   format "->>>>9"          label "Tbl#"
     2921     field tblAreaNum as integer   format ">>>>9"           label "Area#"
     2922     field tblName    as character format "x(30)"           label "Table Name"
     2923     field dbaRM      as decimal   format ">>>>>>>>>>>>"    label "RM Chain"
     2924     field dbaRecs    as decimal   format ">>>>>>>>>>>>"    label "#Records"
     2925     field dbaFragPct as decimal   format ">>>>>9.99%"      label "Frag%"
     2926     field dbaScatter as decimal   format ">>>>"            label "Scat"
     2927     field tblTurn    as decimal   format ">>>>>>9.99"      label "Turns"
     2928     field dbaAvgRow  as decimal   format ">>>>>>>"         label "AvgRow"
     2929     field tblCr      as decimal   format ">>>>>>>>9"       label "Create"
     2930     field tblRd      as decimal   format ">>>>>>>>>9"      label "Read"
     2931     field tblUp      as decimal   format ">>>>>>>>9"       label "Update"
     2932     field tblDl      as decimal   format ">>>>>>>>9"       label "Delete"
     2933     field tblOSRd    as decimal   format ">>>>>>>>9"       label "OS Read"
     2934   
     2935    */
     2936   
     2937   define temp-table tt_uTbl no-undo
     2938     field xid        as integer   format "->>>>9"
     2939     field tblNum     as integer   format "->>>>9"          label "Tbl#"
     2940     field areaNum    as integer   format ">>>>9"           label "Area#"
     2941   
     2942     field tblName    as character format "x(30)"           label "Table Name"
     2943     field dbaRM      as decimal   format ">>>>>>>>>>>>"    label "RM Chain"
     2944     field dbaRecs    as decimal   format ">>>>>>>>>>>>"    label "#Records"
     2945     field dbaFragPct as decimal   format ">>>>>9.99%"      label "Frag%"
     2946     field dbaScatter as decimal   format ">>>>"            label "Scat"
     2947     field tblTurn    as decimal   format ">>>>>>9.99"      label "Turns"
     2948     field dbaAvgRow  as decimal   format ">>>>>>>"         label "AvgRow"
     2949     field tblCreate  as decimal   format ">>>>>>>>9"       label "Create"
     2950     field tblRead    as decimal   format ">>>>>>>>>9"      label "Read"
     2951     field tblUpdate  as decimal   format ">>>>>>>>9"       label "Update"
     2952     field tblDelete  as decimal   format ">>>>>>>>9"       label "Delete"
     2953     field tblOSRd    as decimal   format ">>>>>>>>9"       label "OS Read"
     2954   
     2955     index tblRead-idx is primary tblRead descending
     2956     index tblNum-idx  is unique tblNum
     2957     index tblname-idx is unique tblName
     2958     index xid-idx     is unique xid
     2959     index dbaRecs-idx   dbaRecs   descending
     2960     index tblTurn-idx   tblTurn   descending
     2961     index tblCreate-idx tblCreate descending
     2962     index tblUpdate-idx tblUpdate descending
     2963     index tblDelete-idx tblDelete descending
     2964     index tblOSRd-idx   tblOSRd   descending
     2965   .
     2966   
     2967   /*
     2968     field xid        as integer   format "->>>>9"
     2969     field idxNum     as integer   format "->>>>9"       label "Idx#"
     2970     field idxAreaNum as integer   format ">>>>9"        label "Area#"
     2971     field idxName    as character format "x(44)"        label "Index Name"
     2972   
     2973     field idxBlks    as {&BIGINT} format ">>>>>>>>>>9"  label "Blocks"
     2974     field idxUtil    as decimal   format ">>>>>9.99%"   label "Util"
     2975     field idxLvls    as decimal   format ">>>9"         label "Lvls"
     2976   
     2977     field idxRoot    as {&BIGINT} format ">>>>>>>>>9"   label "Idx Root"
     2978     field idxNote    as character format "   x(4)"      label "  Note "
     2979     field idxCr      as decimal   format ">>>>>>>>9"    label "Create"
     2980     field idxRd      as decimal   format ">>>>>>>>>9"   label "Read"
     2981     field idxSp      as decimal   format ">>>>>>>>9"    label "Split"
     2982     field idxDl      as decimal   format ">>>>>>>>9"    label "Delete"
     2983     field idxBlkDl   as decimal   format ">>>>>>>>9"    label "BlkDl"
     2984   
     2985    */
     2986   
     2987   define temp-table tt_uIdx no-undo
     2988     field xid        as integer   format "->>>>9"
     2989     field idxNum     as integer   format "->>>>9"       label "Idx#"
     2990     field areaNum    as integer   format ">>>>9"        label "Area#"
     2991     field idxName    as character format "x(44)"        label "Index Name"
     2992   
     2993     field idxBlks    as int64 format ">>>>>>>>>>9"  label "Blocks"
     2994     field idxUtil    as decimal   format ">>>>>9.99%"    label "Util"
     2995     field idxLvls    as decimal   format ">>>9"         label "Lvls"
     2996   
     2997     field idxRoot    as int64 format ">>>>>>>>>9"   label "Idx Root"
     2998     field idxNote    as character format "   x(4)"      label "  Note "
     2999     field idxCreate  as decimal   format ">>>>>>>>9"    label "Create"
     3000     field idxRead    as decimal   format ">>>>>>>>>9"   label "Read"
     3001     field idxSplit   as decimal   format ">>>>>>>>9"    label "Split"
     3002     field idxDelete  as decimal   format ">>>>>>>>9"    label "Delete"
     3003     field idxBlkDel  as decimal   format ">>>>>>>>9"    label "BlkDl"
     3004   
     3005     index id-idx      is unique idxNum
     3006     index idxRead-idx is unique primary idxRead descending idxNum
     3007     index xid-idx     is unique xid
     3008   .
     3009   
     3010   define temp-table tt_uStack no-undo
     3011     field xid          as integer   format "->>>>9"
     3012     field depth        as integer   format ">>>>9"   label "Depth"
     3013     field lineNum      as integer   format "->>>>9"  label "Line#"
     3014     field procName     as character format "x(142)"   label "Program Name"
     3015   /*
     3016     field IPName       as character format "x(49)"   label "Routine (IP)"
     3017    */
     3018     index depth-idx is unique primary depth descending
     3019     index xid-idx   is unique xid
     3020   .
     3021   
     3022   
     3023   /* lib/dumpTT.i
     3024    *
     3025    * simplified to a single line -- include should be eliminated.
     3026    *
     3027    */
     3028   
     3029   &IF DECIMAL(SUBSTRING(PROVERSION,1,INDEX(PROVERSION,".") + 1)) >= 10.1 &THEN
     3030   /*** +++
     3031   file-info:file-name = "./ptdefs".
     3032   if file-info:full-pathname <> ? and index( file-info:file-type, "d" ) > 0 and index( file-info:file-type, "w" ) > 0 then
     3033     do:
     3034   
     3035       file-info:file-name = "./ptdefs/{1}.xsd".
     3036   
     3037       if true /* file-info:full-pathname = ? or file-info:file-size = 0 */ then
     3038         do:
     3039   
     3040           temp-table {1}:write-xmlschema(
     3041             "file",
     3042   /*        substitute( "ptdefs/&1.xsd", "{1}" ), */
     3043   /*        "./ptdefs/{1}.xsd", */
     3044             ( if opsys = "unix" then "./ptdefs/{1}.xsd" else ".~\ptdefs~\{1}.xsd" ),
     3045             true
     3046   
     3047         &IF DECIMAL(SUBSTRING(PROVERSION,1,INDEX(PROVERSION,".") + 1)) >= 10.2
     3048         &THEN
     3049             , ?, ?, ?
     3050         &ENDIF
     3051   
     3052       ).
     3053   
     3054       end.
     3055   
     3056     end.
     3057    +++ ***/
     3058   &ENDIF
     3059    
     3060   
     3061   /* lib/dumpTT.i
     3062    *
     3063    * simplified to a single line -- include should be eliminated.
     3064    *
     3065    */
     3066   
     3067   &IF DECIMAL(SUBSTRING(PROVERSION,1,INDEX(PROVERSION,".") + 1)) >= 10.1 &THEN
     3068   /*** +++
     3069   file-info:file-name = "./ptdefs".
     3070   if file-info:full-pathname <> ? and index( file-info:file-type, "d" ) > 0 and index( file-info:file-type, "w" ) > 0 then
     3071     do:
     3072   
     3073       file-info:file-name = "./ptdefs/{1}.xsd".
     3074   
     3075       if true /* file-info:full-pathname = ? or file-info:file-size = 0 */ then
     3076         do:
     3077   
     3078           temp-table {1}:write-xmlschema(
     3079             "file",
     3080   /*        substitute( "ptdefs/&1.xsd", "{1}" ), */
     3081   /*        "./ptdefs/{1}.xsd", */
     3082             ( if opsys = "unix" then "./ptdefs/{1}.xsd" else ".~\ptdefs~\{1}.xsd" ),
     3083             true
     3084   
     3085         &IF DECIMAL(SUBSTRING(PROVERSION,1,INDEX(PROVERSION,".") + 1)) >= 10.2
     3086         &THEN
     3087             , ?, ?, ?
     3088         &ENDIF
     3089   
     3090       ).
     3091   
     3092       end.
     3093   
     3094     end.
     3095    +++ ***/
     3096   &ENDIF
     3097    
     3098   
     3099   /* lib/dumpTT.i
     3100    *
     3101    * simplified to a single line -- include should be eliminated.
     3102    *
     3103    */
     3104   
     3105   &IF DECIMAL(SUBSTRING(PROVERSION,1,INDEX(PROVERSION,".") + 1)) >= 10.1 &THEN
     3106   /*** +++
     3107   file-info:file-name = "./ptdefs".
     3108   if file-info:full-pathname <> ? and index( file-info:file-type, "d" ) > 0 and index( file-info:file-type, "w" ) > 0 then
     3109     do:
     3110   
     3111       file-info:file-name = "./ptdefs/{1}.xsd".
     3112   
     3113       if true /* file-info:full-pathname = ? or file-info:file-size = 0 */ then
     3114         do:
     3115   
     3116           temp-table {1}:write-xmlschema(
     3117             "file",
     3118   /*        substitute( "ptdefs/&1.xsd", "{1}" ), */
     3119   /*        "./ptdefs/{1}.xsd", */
     3120             ( if opsys = "unix" then "./ptdefs/{1}.xsd" else ".~\ptdefs~\{1}.xsd" ),
     3121             true
     3122   
     3123         &IF DECIMAL(SUBSTRING(PROVERSION,1,INDEX(PROVERSION,".") + 1)) >= 10.2
     3124         &THEN
     3125             , ?, ?, ?
     3126         &ENDIF
     3127   
     3128       ).
     3129   
     3130       end.
     3131   
     3132     end.
     3133    +++ ***/
     3134   &ENDIF
     3135    
     3136   
     3137   /* lib/dumpTT.i
     3138    *
     3139    * simplified to a single line -- include should be eliminated.
     3140    *
     3141    */
     3142   
     3143   &IF DECIMAL(SUBSTRING(PROVERSION,1,INDEX(PROVERSION,".") + 1)) >= 10.1 &THEN
     3144   /*** +++
     3145   file-info:file-name = "./ptdefs".
     3146   if file-info:full-pathname <> ? and index( file-info:file-type, "d" ) > 0 and index( file-info:file-type, "w" ) > 0 then
     3147     do:
     3148   
     3149       file-info:file-name = "./ptdefs/{1}.xsd".
     3150   
     3151       if true /* file-info:full-pathname = ? or file-info:file-size = 0 */ then
     3152         do:
     3153   
     3154           temp-table {1}:write-xmlschema(
     3155             "file",
     3156   /*        substitute( "ptdefs/&1.xsd", "{1}" ), */
     3157   /*        "./ptdefs/{1}.xsd", */
     3158             ( if opsys = "unix" then "./ptdefs/{1}.xsd" else ".~\ptdefs~\{1}.xsd" ),
     3159             true
     3160   
     3161         &IF DECIMAL(SUBSTRING(PROVERSION,1,INDEX(PROVERSION,".") + 1)) >= 10.2
     3162         &THEN
     3163             , ?, ?, ?
     3164         &ENDIF
     3165   
     3166       ).
     3167   
     3168       end.
     3169   
     3170     end.
     3171    +++ ***/
     3172   &ENDIF
     3173    
     3174   
     3175   define variable pt_trimStack as character no-undo.      /* a list of items to automatically remove from the program stack       */
     3176   
     3177   define variable bh  as handle no-undo.
     3178   define variable bf  as handle no-undo.
     3179   define variable bf2 as handle no-undo.
     3180   define variable qh  as handle no-undo.
     3181   define variable qut as handle no-undo.
     3182   define variable qui as handle no-undo.
     3183   define variable qx  as handle no-undo.
     3184   define variable qy  as handle no-undo.
     3185   define variable qz  as handle no-undo.
     3186   define variable qo  as handle no-undo.
     3187   
     3188   define variable but as handle no-undo.
     3189   define variable bui as handle no-undo.
     3190   
     3191   define variable hasCnxCache  as logical no-undo.
     3192   define variable hasUsrStats  as logical no-undo.
     3193   define variable hasUsrExt    as logical no-undo.
     3194   
     3195   procedure chkCnx:
     3196     hasCnxCache  = no.
     3197     find dictdb._File  no-lock where _File-Name = "_Connect" no-error.
     3198     if not available _File then return.
     3199     find dictdb._Field no-lock where _Field._File-recid = recid( _File ) and _Field-Name = "_Connect-CacheInfo" no-error.
     3200     if available _Field then hasCnxCache = yes.
     3201     return.
     3202   end.
     3203   
     3204   procedure chkUsrStats:
     3205     hasUsrStats  = no.
     3206     find dictdb._File  no-lock where _File-Name = "_UserTableStat" no-error.
     3207     if available _File then
     3208       do:
     3209         hasUsrStats = yes.
     3210         create buffer but for table "dictdb._userTableStat".
     3211         create query qut.
     3212         qut:set-buffers( but ).
     3213         create buffer bui for table "dictdb._userIndexStat".
     3214         create query qui.
     3215         qui:set-buffers( bui ).
     3216       end.
     3217     return.
     3218   end.
     3219   
     3220   procedure chkUsrExt:
     3221     hasUsrExt  = no.
     3222     find dictdb._File  no-lock where _File-Name = "_User" no-error.
     3223     if not available _file then return.
     3224     find dictdb._Field no-lock where _Field._File-recid = recid( _File ) and _Field-Name = "_Telephone" no-error.
     3225     if available _Field then hasUsrExt = yes.
     3226     return.
     3227   end.
     3228   
     3229   procedure chkOSRd:
     3230     hasOSRd = no.
     3231     find _file no-lock where _file._file-name = "_usertablestat" no-error.
     3232     if available _file then find _field no-lock of _file where _field._field-name = "_usertablestat-osread" no-error.
     3233     hasOSRd = available( _field ).
     3234     return.
     3235   end.
     3236   
     3237   procedure mon-init:
     3238   
     3239     run chkCnx.
     3240     run chkUsrStats.
     3241     run chkUsrExt.
     3242     run chkOSRd.
     3243   
     3244   /* */
     3245     create tt_userInfo.
     3246   
     3247   /***
     3248     create tt_uTbl.
     3249     create tt_uIdx.
     3250     create tt_uStack.
     3251    ***/
     3252   
     3253   /***
     3254     create query qh.
     3255     qh:set-buffers( buffer tt_userInfo:handle ).
     3256     qh:query-prepare( "preselect each tt_userInfo" ).
     3257     qh:query-open.
     3258   
     3259     create query qx.
     3260     qx:set-buffers( buffer tt_uTbl:handle ).
     3261     qx:query-prepare( "preselect each tt_uTbl" ).
     3262     qx:query-open.
     3263   
     3264     create query qy.
     3265     qy:set-buffers( buffer tt_uIdx:handle ).
     3266     qy:query-prepare( "preselect each tt_uIdx" ).
     3267     qy:query-open.
     3268   
     3269     create query qz.
     3270     qz:set-buffers( buffer tt_uStack:handle ).
     3271     qz:query-prepare( "preselect each tt_uStack" ).
     3272     qz:query-open.
     3273    ***/
     3274   
     3275     create query qo.
     3276     qo:set-buffers( buffer tt_uOther:handle ).
     3277     qo:query-prepare( "preselect each tt_uOther" ).
     3278     qo:query-open.
     3279   
     3280   &IF DEFINED( OE10 ) &THEN
     3281     prevTick = mtime.
     3282   &ELSE
     3283     prevTick = etime.
     3284   &ENDIF
     3285   
     3286     return.
     3287   
     3288   end.
     3289   
     3290   procedure mon-update:
     3291   
     3292     define input parameter argList as character no-undo.
     3293   
     3294     define variable i   as integer no-undo.
     3295     define variable j   as integer no-undo.
     3296     define variable k   as integer no-undo.
     3297     define variable rLk as integer no-undo.
     3298   
     3299     define variable qs      as character no-undo.
     3300   
     3301     define variable firstId as integer no-undo.
     3302     define variable lastId  as integer no-undo.
     3303   
     3304     define variable stackEntry as character no-undo.
     3305   
     3306     define variable xUsr as integer no-undo.
     3307     define variable xPID as integer no-undo initial ?.
     3308   
     3309     find tt_userInfo no-error.
     3310   
     3311     if argList <> "" then
     3312       do:
     3313         if argList begins "USR" then
     3314           assign xUsr = integer( entry( 2, argList, "=" )) no-error.
     3315          else if argList begins "PID" then
     3316           do:
     3317             assign xPID = integer( entry( 2, argList, "=" )) no-error.
     3318             find first _Connect no-lock where _Connect._Connect-pid = xPID no-error.      /* _connect ought to be cached to a TT  */
     3319             if available _Connect then xUsr =  _Connect-usr.
     3320           end.
     3321       end.
     3322   
     3323     if xUsr <> tt_userInfo.usrNum then run set-user( xUsr ).
     3324   
     3325     empty temp-table tt_uStack.
     3326     create tt_uStack.
     3327     assign
     3328       tt_uStack.xid      = 0
     3329       tt_uStack.lineNum  = 0
     3330       tt_uStack.procName = "4GL Stack Trace not available " + ( if hasCnxCache then "for this session." else "in this version of Progress." )
     3331     .
     3332   
     3333     find dictdb._Connect no-lock where _Connect-id = tt_userInfo.usrNum + 1 and _Connect-usr <> ? no-error.
     3334     if not available( _Connect ) then
     3335       do:
     3336         assign
     3337           tt_userInfo.usrId       = 0
     3338           tt_userInfo.usrName     = ""
     3339           tt_userInfo.usrFullName = ""
     3340           tt_userInfo.usrPhone    = ""
     3341           tt_userInfo.usrEMail    = ""
     3342           tt_userInfo.usrIPAddr   = ""
     3343           tt_userInfo.usrPID      = 0
     3344           tt_userInfo.usrLoginTm  = ""
     3345           tt_userInfo.usrServ     = 0
     3346           tt_userInfo.SessionInfo = ""
     3347           tt_userInfo.TrxInfo     = ""
     3348         .
     3349       end.
     3350      else
     3351       do:
     3352   
     3353         assign
     3354           tt_userInfo.usrId       = _Connect-Id
     3355           tt_userInfo.usrName     = _Connect-Name
     3356           tt_userInfo.usrPID      = _Connect-PID
     3357           tt_userInfo.usrLoginTm  = _Connect-Time
     3358           tt_userInfo.usrServ     = ( if _Connect-Server = ? then 0 else _Connect-Server )
     3359           tt_userInfo.usrFullName = ""
     3360           tt_userInfo.usrPhone    = ""
     3361           tt_userInfo.usrEMail    = ""
     3362           tt_userInfo.usrIPAddr   = ( if _Connect-Device = "batch" then "" else _Connect-Device )
     3363         .
     3364   
     3365         empty temp-table tt_uOther.
     3366         for each _Connect no-lock where _Connect-Usr <> ? and _Connect-Name = tt_userInfo.usrName:
     3367           if _Connect-Usr <> tt_userInfo.usrNum then
     3368             do:
     3369               create tt_uOther.
     3370               assign
     3371                 tt_uOther.usrType    = connectFlags( _connect-Id )        /* UDF has to be before indexed fields in old releases  */
     3372                 tt_uOther.xid        = _Connect-Usr
     3373                 tt_uOther.usrNum     = _Connect-Usr
     3374                 tt_uOther.usrPID     = _Connect-PID
     3375              /* tt_uOther.usrType    = _Connect-Type + ( if _Connect-Device = "batch" then " BAT" else "" ) */
     3376                 tt_uOther.usrServ    = ( if _Connect-Server = ? then 0 else _Connect-Server )
     3377                 tt_uOther.usrLoginTM = substring( _Connect-Time, 5 )
     3378                 tt_uOther.usrIPAddr  = ( if _Connect-Device = "batch" then "" else _Connect-device )
     3379               .
     3380               if hasCnxCache then
     3381                 do:
     3382                   assign
     3383                     bh = buffer _Connect:handle
     3384                     bf = bh:buffer-field( "_Connect-IPAddress" )
     3385                     tt_uOther.usrIPAddr = ( if bf <> ? and bf:buffer-value() <> "" and bf:buffer-value() <> ? then bf:buffer-value() else tt_uOther.usrIPAddr )
     3386                  /* bf = bh:buffer-field( "_Connect-ClientType" )
     3387                   * tt_uOther.usrType = ( if bf <> ? and bf:buffer-value() <> "" and bf:buffer-value() <> ? then trim( bf:buffer-value()) + " " else "" ) + tt_uOther.usrType
     3388                   */
     3389                     bf  = bh:buffer-field( "_Connect-CacheLineNumber" )
     3390                     bf2 = bh:buffer-field( "_Connect-CacheInfo" )
     3391                     stackEntry = bf2:buffer-value( 1 )
     3392                   .
     3393                   k = num-entries( pt_trimStack ).
     3394                   do j = 1 to k:
     3395                     stackEntry = replace( stackEntry, entry( j, pt_trimStack ), "" ).
     3396                   end.
     3397                   if stackEntry <> ? and stackEntry <> "" then
     3398                     assign
     3399                       tt_uOther.lineNum  = bf:buffer-value( 1 )
     3400                    /* tt_uOther.IPName   = ( if num-entries( stackEntry, " " ) > 1 then entry( 1, stackEntry, " " ) else "" )
     3401                     * tt_uOther.procName = trim( stackEntry, tt_uOther.IPName )
     3402                     * tt_uOther.procName = trim( tt_uOther.procName ) */
     3403                       tt_uOther.procName = stackEntry
     3404                     .
     3405                 end.
     3406             end.
     3407         end.
     3408         qo:query-open.
     3409   
     3410         find dictdb._Connect no-lock where _Connect-id = tt_userInfo.usrNum + 1 and _Connect-usr <> ? no-error.
     3411   
     3412         find dictdb._User no-lock where _UserId = _Connect-Name no-error.
     3413         if available _User then
     3414           do:
     3415             assign
     3416               tt_userInfo.usrFullName = _User-Name
     3417               tt_userInfo.usrPhone    = _User-Misc
     3418               tt_userInfo.usrEMail    = _U-Misc2[1]
     3419             .
     3420             if hasUsrExt then
     3421               do:
     3422                 bh = buffer _User:handle.
     3423                 bf = bh:buffer-field( "_Telephone" ).
     3424                 if bf <> ? and bf:buffer-value() <> "" and bf:buffer-value() <> ? then tt_userInfo.usrPhone = bf:buffer-value().
     3425                 bf = bh:buffer-field( "_Email" ).
     3426                 if bf <> ? and bf:buffer-value() <> "" and bf:buffer-value() <> ? then tt_userInfo.usrEMail = bf:buffer-value().
     3427                 bf = bh:buffer-field( "_Given_Name" ).
     3428                 if bf <> ? and bf:buffer-value() <> "" and bf:buffer-value() <> ? then tt_userInfo.usrFullName = bf:buffer-value().
     3429                 bf = bh:buffer-field( "_Middle_Initial" ).
     3430                 if bf <> ? and bf:buffer-value() <> "" and bf:buffer-value() <> ? then tt_userInfo.usrFullName = tt_userInfo.usrFullName + " " + bf:buffer-value() + ".".
     3431                 bf = bh:buffer-field( "_Surname" ).
     3432                 if bf <> ? and bf:buffer-value() <> "" and bf:buffer-value() <> ? then tt_userInfo.usrFullName = tt_userInfo.usrFullName + " " + bf:buffer-value().
     3433               end.
     3434           end.
     3435   
     3436         find dictdb._UserIO no-lock where _UserIO-Id = tt_userInfo.usrId.
     3437   
     3438         run update_xstat(
     3439           input 1,
     3440           input "",
     3441           input "m1",
     3442           input "m2",
     3443           input "m3",
     3444           input "m4",
     3445           input "m5",
     3446           input _UserIO-dbaccess,
     3447           input _UserIO-dbread,
     3448           input _UserIO-dbwrite,
     3449           input 0,
     3450           input 0,
     3451           input 0
     3452         ).
     3453   
     3454         run update_xstat(
     3455           input 2,
     3456           input "",
     3457           input "m1",
     3458           input "m2",
     3459           input "m3",
     3460           input "m4",
     3461           input "m5",
     3462           input _UserIO-biread,
     3463           input _UserIO-biwrite,
     3464           input _UserIO-airead,
     3465           input _UserIO-aiwrite,
     3466           input 0,
     3467           input 0
     3468         ).
     3469   
     3470         run updTick.
     3471         run age_xstat.
     3472   
     3473         if hasUsrStats then
     3474           do:
     3475   
     3476             assign
     3477               firstId = _Connect-Usr * tRange
     3478               lastId  = firstId + min( tRange, tUsed )
     3479               firstId = firstId + 1
     3480               qs = substitute( "preselect each dictdb.&1 no-lock where &2 >= &3 and &2 <= &4", "_UserTableStat", "_UserTableStat-Id", string( firstId ), string( lastId ))
     3481             .
     3482             qut:query-prepare( qs ).
     3483             qut:query-open.
     3484             qut:get-first( no-lock ) no-error.
     3485             do while ( qut:query-off-end = no ):
     3486               run upd-tt_utable ( but:buffer-field( "_userTableStat-Id" ):buffer-value /* _UserTableStat._UserTableStat-id */ ).
     3487               qut:get-next( no-lock ) no-error.
     3488             end.
     3489   
     3490             run age_utable.
     3491   
     3492             empty temp-table tt_uTbl.
     3493   
     3494             for each tt_utable no-lock:
     3495               /* i = i + 1. */
     3496               create tt_uTbl.
     3497               assign
     3498                 tt_uTbl.xid       = tt_utable.tblNum
     3499                 tt_uTbl.tblNum    = tt_utable.tblNum
     3500                 tt_uTbl.areaNum   = tt_utable.areaNum
     3501                 tt_uTbl.tblName   = tt_utable.tblName
     3502                 tt_uTbl.tblCreate = ( tt_utable.tbl-cre[x] / z )
     3503                 tt_uTbl.tblRead   = ( tt_utable.tbl-rd[x]  / z )
     3504                 tt_uTbl.tblUpdate = ( tt_utable.tbl-upd[x] / z )
     3505                 tt_uTbl.tblDelete = ( tt_utable.tbl-del[x] / z )
     3506                 tt_uTbl.tblOSRd   = ( tt_utable.tbl-osrd[x] / z )
     3507               .
     3508               run getTableInfo(
     3509                 tt_uTbl.tblName,
     3510                 output tt_uTbl.dbaRecs,
     3511                 output tt_uTbl.dbaRM,
     3512                 output tt_uTbl.dbaFragPct,
     3513                 output tt_uTbl.dbaScatter,
     3514                 output tt_uTbl.dbaAvgRow
     3515               ).
     3516               if tt_uTbl.dbaRecs > 0 then tt_uTbl.tblTurn = tt_uTbl.tblRead / tt_uTbl.dbaRecs.
     3517             end.
     3518   
     3519             assign
     3520               firstId = _connect-usr * iRange
     3521               lastId  = firstId + min( iRange, iUsed )
     3522               firstId = firstId + 1
     3523               qs = substitute( "preselect each dictdb.&1 no-lock where &2 >= &3 and &2 <= &4", "_UserIndexStat", "_UserIndexStat-Id", string( firstId ), string( lastId ))
     3524             .
     3525   
     3526             qui:query-prepare( qs ).
     3527             qui:query-open.
     3528             qui:get-first( no-lock ) no-error.
     3529             do while ( qui:query-off-end = no ):
     3530               run upd-tt_uindex ( bui:buffer-field( "_userIndexStat-Id" ):buffer-value ).
     3531               qui:get-next( no-lock ) no-error.
     3532             end.
     3533   
     3534             run age_uindex.
     3535   
     3536             empty temp-table tt_uIdx.
     3537   
     3538             for each tt_uindex no-lock:
     3539               create tt_uIdx.
     3540               assign
     3541                 tt_uIdx.xid       = tt_uindex.idxNum
     3542                 tt_uIdx.idxNum    = tt_uindex.idxNum
     3543                 tt_uIdx.areaNum   = tt_uindex.areaNum
     3544                 tt_uIdx.idxRoot   = tt_uindex.idxRoot
     3545                 tt_uIdx.idxName   = tt_uindex.idxName
     3546                 tt_uIdx.idxCreate = ( tt_uindex.idx-cre[x] / z )
     3547                 tt_uIdx.idxRead   = ( tt_uindex.idx-rd[x]  / z )
     3548                 tt_uIdx.idxSplit  = ( tt_uindex.idx-split[x] / z )
     3549                 tt_uIdx.idxDelete = ( tt_uindex.idx-del[x] / z )
     3550                 tt_uIdx.idxBlkDel = ( tt_uindex.idx-blkdel[x] / z )
     3551                 tt_uIdx.idxNote   = tt_uindex.idxNote
     3552               .
     3553               run getIndexInfo( tt_uIdx.idxName, output tt_uIdx.idxLvls, output tt_uIdx.idxBlks, output tt_uIdx.idxUtil ).
     3554             end.
     3555   
     3556           end.
     3557   
     3558         /*** interesting but not currently used     
     3559          *  i = 0.
     3560          *  find dictdb._UserLock no-lock where _UserLock-Id = _Connect-Id.
     3561          *  do while i < 512 and _UserLock-Recid[i + 1] <> ?:
     3562          *    i = i + 1.
     3563          *  end.
     3564          ***/
     3565   
     3566         find tt_xstat where tt_xstat.xid = 1 no-error.
     3567         assign
     3568           tt_userInfo.usrDBA      = ( tt_xstat.stat1[x] / z )
     3569           tt_userInfo.usrDBR      = ( tt_xstat.stat2[x] / z )
     3570           tt_userInfo.usrHR       = ( if tt_xstat.stat-ratio = ? then 100.00 else tt_xstat.stat-ratio )
     3571           tt_userInfo.usrDBW      = ( tt_xstat.stat3[x] / z )
     3572           tt_userInfo.usrRecLks   = i
     3573         no-error.
     3574         find tt_xstat where tt_xstat.xid = 2 no-error.
     3575         assign
     3576           tt_userInfo.usrBIRd     = ( tt_xstat.stat1[x] / z )
     3577           tt_userInfo.usrBIWr     = ( tt_xstat.stat2[x] / z )
     3578           tt_userInfo.usrAIRd     = ( tt_xstat.stat3[x] / z )
     3579           tt_userInfo.usrAIWr     = ( tt_xstat.stat4[x] / z )
     3580         no-error.
     3581   
     3582         tt_userInfo.SessionInfo =
     3583           _Connect-Type + " " + connectFlags( _connect-id ) + " " +
     3584           ( if _Connect-Type = "SELF" or _Connect-type = "REMC" then ( if _Connect-Batch = "Yes" then "Batch " else "" ) else "Background" ) +
     3585           ( if _Connect-Transid > 0 then "TRX " else "" ) +
     3586           ( if _Connect-Wait <> " -- " then "Blocked on " + _Connect-Wait else "" )
     3587         .
     3588   
     3589         find first dictdb._Trans no-lock where _Trans-UsrNum = _Connect-Usr no-error.
     3590   
     3591         if available _Trans then
     3592           tt_userInfo.TrxInfo =
     3593             _Trans-state + " " +
     3594             _Trans-flags + " " +
     3595             string( _Trans-Num ) + " " +
     3596             /* ( if _Trans-txtime = ? then "" else _Trans-txtime ) + " " + */
     3597             "Duration: " + ( if _Trans-duration = ? then "" else string( _Trans-duration, "hh:mm:ss" )) + " " +
     3598             "Waiting On: " + ( if available _Connect then ( string( _Connect-wait ) + " " + string( _Connect-wait1 )) else "" ).
     3599          else
     3600           tt_userInfo.TrxInfo = "--None--".
     3601   
     3602         if hasCnxCache then
     3603           do:
     3604   
     3605             bh = buffer _Connect:handle.
     3606   
     3607             /* enable the client statement cache for this user
     3608              *
     3609              * 1 = single statement, 2 = whole stack, 3 = one time
     3610              *
     3611              */
     3612   /*
     3613    *        bf = bh:buffer-field( "_Connect-CachingType" ).
     3614    *        if bf <> ? and bf:buffer-value() = ? then bf:buffer-value() = 2.
     3615    */
     3616             bf = bh:buffer-field( "_Connect-ClientType" ).
     3617             if bf <> ? and bf:buffer-value() <> "" and bf:buffer-value() <> ? then tt_userInfo.SessionInfo = trim( bf:buffer-value()) + " " + tt_userInfo.SessionInfo.
     3618   
     3619             bf = bh:buffer-field( "_Connect-IPAddress" ).
     3620             if bf <> ? and bf:buffer-value() <> "" and bf:buffer-value() <> ? then tt_userInfo.usrIPAddr = bf:buffer-value().
     3621   
     3622             bf = bh:buffer-field( "_Connect-CacheLineNumber" ).
     3623             bf2 = bh:buffer-field( "_Connect-CacheInfo" ).
     3624   
     3625             if bf:buffer-value( 1 ) <> ? then empty temp-table tt_uStack.
     3626             getStack: do i = 1 to 32:
     3627               if bf:buffer-value( i ) = ? then
     3628                 leave getStack.
     3629                else
     3630                 do:
     3631                   create tt_uStack.
     3632                   stackEntry = bf2:buffer-value( i ).
     3633                   k = num-entries( pt_trimStack ).
     3634                   do j = 1 to k:
     3635                     stackEntry = replace( stackEntry, entry( j, pt_trimStack ), "" ).
     3636                   end.
     3637                   assign
     3638                     tt_uStack.xid      = i
     3639                     tt_uStack.depth    = i
     3640                     tt_uStack.lineNum  = bf:buffer-value( i )
     3641                  /* tt_uStack.IPName   = ( if num-entries( stackEntry, " " ) > 1 then entry( 1, stackEntry, " " ) else "" )
     3642                   * tt_uStack.procName = trim( stackEntry, tt_uStack.IPName )
     3643                   * tt_uStack.procName = trim( tt_uStack.procName ) */
     3644                     tt_uStack.procName = stackEntry
     3645                   .
     3646                 end.
     3647             end.
     3648   
     3649           end.
     3650   
     3651       end.
     3652   
     3653     add2ds( temp-table tt_userInfo:default-buffer-handle ).
     3654     add2ds( temp-table tt_uTbl:default-buffer-handle ).
     3655     add2ds( temp-table tt_uIdx:default-buffer-handle ).
     3656     add2ds( temp-table tt_uStack:default-buffer-handle ).
     3657     add2ds( temp-table tt_uOther:default-buffer-handle ).
     3658   
     3659     return.
     3660   
     3661   end.
     3662   
     3663   procedure set-User:
     3664   
     3665     define input parameter p_usr as integer no-undo.
     3666   
     3667     find first tt_userInfo.
     3668     tt_userInfo.usrNum = p_usr.
     3669     empty temp-table tt_xstat.            /* changing the user invalidates the xstats...  */
     3670   
     3671     /* run mon-update. */
     3672   
     3673     return.
     3674   
     3675   end.
     3676   
     3677   return.
