<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
  <meta name="generator" content="HtmlDict.w version 11">
  <meta name="author"    content="Patrick Tingen [patrick at tingen dot nl]">
  <link rel="stylesheet" title="Default" type="text/css" href="../../default.css">
  <link rel="alternate stylesheet" title="blue" type="text/css" href="../../blue.css">
  <link rel="alternate stylesheet" title="default" type="text/css" href="../../default.css">
  <link rel="alternate stylesheet" title="green" type="text/css" href="../../green.css">
  <link rel="alternate stylesheet" title="oldstyle" type="text/css" href="../../oldstyle.css">
  <link rel="alternate stylesheet" title="red" type="text/css" href="../../red.css">
  <link rel="shortcut icon" href="../../htmldict.ico">
  <link rel="stylesheet" media="print" type="text/css" href="../../print.css">
  <script src="../../swapstyle.js"    type="text/javascript"></script>
  <script src="../../stylechooser.js" type="text/javascript"></script>
  <script src="../../dbchooser.js"    type="text/javascript"></script>
  <script src="../../htmldict.js"     type="text/javascript"></script>
  <title> Trigger code: write of reftable</title>
</head>
<body onload="useStyleAgain('HtmlDict');" onunload="rememberStyle('HtmlDict',10);">
<div><a name="top"></a></div>
<table style="width:100%;">
  <tr>
    <td class="navbar" style="width:80%;"><a href="../../../00-index.html"target="_top">DB</a>
 | <a href="../../00-area.html"target="main">Areas</a>
 | <a href="../../00-cross.html"target="main">X-idx</a>
 | <a href="../../00-main.html"target="main">Tables</a>
 | <a href="../../00-sequences.html"target="main">Sequences</a>
</td>
    <td class="navbar" style="width:20%; text-align:right;"><a href="../../htmldict.html"target="_top">HtmlDict 11</a></td>
  </tr>
</table>
 
<h1>Trigger code: write of reftable</h1>
<div class="progressCode">
<span class="src-prep">&amp;Scoped-define</span><!--src-prep--> ACTION <span class="src-keyword">UPDATE</span><!--src-keyword-->
<span class="src-prep">&amp;Scoped-define</span><!--src-prep--> <span class="src-keyword">DBNAME</span><!--src-keyword--> ASI
<span class="src-prep">&amp;Scoped-define</span><!--src-prep--> TABLENAME reftable
 
<span class="src-keyword">TRIGGER PROCEDURE FOR WRITE OF</span><!--src-keyword--> <span class="src-prep">{&amp;TABLENAME}</span><!--src-prep--> <span class="src-keyword">OLD BUFFER</span><!--src-keyword--> old-<span class="src-prep">{&amp;TABLENAME}</span><!--src-prep-->.
 
<span class="src-prep">{methods/<span class="src-keyword">triggers</span><!--src-keyword-->/<span class="src-keyword">write</span><!--src-keyword-->.i}</span><!--src-prep-->
 
<span class="src-keyword">DEF VAR</span><!--src-keyword--> lv-est-no <span class="src-keyword">LIKE</span><!--src-keyword--> est.est-no <span class="src-keyword">NO-UNDO</span><!--src-keyword-->.
<span class="src-keyword">DEF VAR</span><!--src-keyword--> li <span class="src-keyword">AS INT NO-UNDO</span><!--src-keyword-->.
<span class="src-keyword">DEF VAR</span><!--src-keyword--> lv-rec-type <span class="src-keyword">AS CHAR NO-UNDO</span><!--src-keyword-->.
<span class="src-keyword">DEF VAR</span><!--src-keyword--> lv-val-type <span class="src-keyword">AS CHAR NO-UNDO</span><!--src-keyword-->.
 
<span class="src-keyword">DEF BUFFER</span><!--src-keyword--> b-ref <span class="src-keyword">FOR</span><!--src-keyword--> <span class="src-prep">{&amp;TABLENAME}</span><!--src-prep-->.
 
<span class="src-keyword">DEF TEMP-TABLE</span><!--src-keyword--> w-ref <span class="src-keyword">FIELD</span><!--src-keyword--> w-qty <span class="src-keyword">AS DEC FIELD</span><!--src-keyword--> w-cst <span class="src-keyword">AS DEC</span><!--src-keyword-->.
 
<span class="src-keyword">DISABLE TRIGGERS FOR LOAD OF</span><!--src-keyword--> est.
<span class="src-keyword">DISABLE TRIGGERS FOR LOAD OF</span><!--src-keyword--> b-ref.
<span class="src-keyword">DISABLE TRIGGERS FOR LOAD OF</span><!--src-keyword--> po-ord.
<span class="src-keyword">DISABLE TRIGGERS FOR LOAD OF</span><!--src-keyword--> po-ordl.
 
 
<span class="src-keyword">IF LOOKUP</span><!--src-keyword-->(<span class="src-prep">{&amp;TABLENAME}</span><!--src-prep-->.reftable,<span class="src-char">"EST-MISC"</span><!--src-char-->) <span class="src-keyword">GT</span><!--src-keyword--> <span class="src-number">0</span><!--src-number--> <span class="src-keyword">THEN DO</span><!--src-keyword-->:
  <span class="src-keyword">IF</span><!--src-keyword--> <span class="src-prep">{&amp;TABLENAME}</span><!--src-prep-->.reftable <span class="src-keyword">EQ</span><!--src-keyword--> <span class="src-char">"EST-MISC"</span><!--src-char--> <span class="src-keyword">THEN DO</span><!--src-keyword-->:
    lv-est-no = <span class="src-char">""</span><!--src-char-->.
    <span class="src-keyword">DO</span><!--src-keyword--> li = <span class="src-number">1</span><!--src-number--> <span class="src-keyword">TO LENGTH</span><!--src-keyword-->(<span class="src-prep">{&amp;TABLENAME}</span><!--src-prep-->.<span class="src-keyword">code</span><!--src-keyword-->):
      <span class="src-keyword">IF SUBSTR</span><!--src-keyword-->(<span class="src-prep">{&amp;TABLENAME}</span><!--src-prep-->.<span class="src-keyword">code</span><!--src-keyword-->,<span class="src-number">1</span><!--src-number-->,<span class="src-number">1</span><!--src-number-->) <span class="src-keyword">EQ</span><!--src-keyword--> <span class="src-char">"/"</span><!--src-char--> <span class="src-keyword">THEN LEAVE</span><!--src-keyword-->.
      lv-est-no = lv-est-no + <span class="src-keyword">SUBSTR</span><!--src-keyword-->(<span class="src-prep">{&amp;TABLENAME}</span><!--src-prep-->.<span class="src-keyword">code</span><!--src-keyword-->,<span class="src-number">1</span><!--src-number-->,<span class="src-number">1</span><!--src-number-->).
    <span class="src-keyword">END</span><!--src-keyword-->.
    lv-est-no = <span class="src-keyword">FILL</span><!--src-keyword-->(<span class="src-char">" "</span><!--src-char-->,<span class="src-number">8</span><!--src-number--> <span class="src-keyword">- LENGTH</span><!--src-keyword-->(<span class="src-keyword">TRIM</span><!--src-keyword-->(lv-est-no))) + <span class="src-keyword">TRIM</span><!--src-keyword-->(lv-est-no).
 
    <span class="src-keyword">IF TRIM</span><!--src-keyword-->(lv-est-no) <span class="src-keyword">NE</span><!--src-keyword--> <span class="src-char">""</span><!--src-char--> <span class="src-keyword">THEN RUN</span><!--src-keyword--> update-est (lv-est-no).
  <span class="src-keyword">END</span><!--src-keyword-->.
 
  <span class="src-keyword">ASSIGN</span><!--src-keyword-->
   lv-rec-type = <span class="src-keyword">SUBSTR</span><!--src-keyword-->(<span class="src-prep">{&amp;TABLENAME}</span><!--src-prep-->.code2,<span class="src-number">1</span><!--src-number-->,<span class="src-number">3</span><!--src-number-->)
   lv-val-type = <span class="src-keyword">SUBSTR</span><!--src-keyword-->(<span class="src-prep">{&amp;TABLENAME}</span><!--src-prep-->.code2,<span class="src-number">5</span><!--src-number-->,<span class="src-number">3</span><!--src-number-->)
   li          = <span class="src-keyword">INT</span><!--src-keyword-->(<span class="src-keyword">SUBSTR</span><!--src-keyword-->(<span class="src-prep">{&amp;TABLENAME}</span><!--src-prep-->.code2,<span class="src-number">8</span><!--src-number-->,<span class="src-number">2</span><!--src-number-->)).
 
  <span class="src-keyword">IF</span><!--src-keyword--> lv-val-type <span class="src-keyword">EQ</span><!--src-keyword--> <span class="src-char">"QTY"</span><!--src-char--> <span class="src-keyword">THEN DO</span><!--src-keyword-->:
    <span class="src-keyword">FIND FIRST</span><!--src-keyword--> b-ref
        <span class="src-keyword">WHERE</span><!--src-keyword--> b-ref.reftable <span class="src-keyword">EQ</span><!--src-keyword--> <span class="src-prep">{&amp;TABLENAME}</span><!--src-prep-->.reftable
          <span class="src-keyword">AND</span><!--src-keyword--> b-ref.company  <span class="src-keyword">EQ</span><!--src-keyword--> <span class="src-prep">{&amp;TABLENAME}</span><!--src-prep-->.company
          <span class="src-keyword">AND</span><!--src-keyword--> b-ref.loc      <span class="src-keyword">EQ</span><!--src-keyword--> <span class="src-prep">{&amp;TABLENAME}</span><!--src-prep-->.loc
          <span class="src-keyword">AND</span><!--src-keyword--> b-ref.<span class="src-keyword">code     EQ</span><!--src-keyword--> <span class="src-prep">{&amp;TABLENAME}</span><!--src-prep-->.<span class="src-keyword">code</span><!--src-keyword-->
          <span class="src-keyword">AND</span><!--src-keyword--> b-ref.code2    <span class="src-keyword">EQ</span><!--src-keyword--> lv-rec-type + <span class="src-char">"-CST"</span><!--src-char--> +
                                (<span class="src-keyword">IF</span><!--src-keyword--> li <span class="src-keyword">GT</span><!--src-keyword--> <span class="src-number">0</span><!--src-number--> <span class="src-keyword">THEN STRING</span><!--src-keyword-->(li,<span class="src-char">"99"</span><!--src-char-->) <span class="src-keyword">ELSE</span><!--src-keyword--> <span class="src-char">""</span><!--src-char-->)
        <span class="src-keyword">NO-ERROR</span><!--src-keyword-->.
 
    <span class="src-keyword">DO</span><!--src-keyword--> li = <span class="src-number">1</span><!--src-number--> <span class="src-keyword">TO EXTENT</span><!--src-keyword-->(<span class="src-prep">{&amp;TABLENAME}</span><!--src-prep-->.val):
      <span class="src-keyword">CREATE</span><!--src-keyword--> w-ref.
      w-qty = <span class="src-prep">{&amp;TABLENAME}</span><!--src-prep-->.val[li].
      <span class="src-keyword">IF AVAIL</span><!--src-keyword--> b-ref <span class="src-keyword">THEN</span><!--src-keyword--> w-cst = b-ref.val[li].
    <span class="src-keyword">END</span><!--src-keyword-->.
    <span class="src-keyword">FOR EACH</span><!--src-keyword--> w-ref <span class="src-keyword">WHERE BREAK BY</span><!--src-keyword--> w-qty <span class="src-keyword">BY</span><!--src-keyword--> w-cst:
      <span class="src-keyword">IF</span><!--src-keyword--> (w-qty <span class="src-keyword">EQ</span><!--src-keyword--> <span class="src-number">0</span><!--src-number--> <span class="src-keyword">OR NOT LAST-OF</span><!--src-keyword-->(w-qty)) <span class="src-keyword">AND</span><!--src-keyword-->
         <span class="src-keyword">NOT LAST</span><!--src-keyword-->(w-qty)                    <span class="src-keyword">THEN DELETE</span><!--src-keyword--> w-ref.
    <span class="src-keyword">END</span><!--src-keyword-->.
 
    <span class="src-prep">{&amp;TABLENAME}</span><!--src-prep-->.val = <span class="src-number">0</span><!--src-number-->.
    <span class="src-keyword">IF AVAIL</span><!--src-keyword--> b-ref <span class="src-keyword">THEN</span><!--src-keyword--> b-ref.val = <span class="src-number">0</span><!--src-number-->.
 
    li = <span class="src-number">0</span><!--src-number-->.
    <span class="src-keyword">FOR EACH</span><!--src-keyword--> w-ref <span class="src-keyword">BREAK BY</span><!--src-keyword--> w-qty <span class="src-keyword">BY</span><!--src-keyword--> w-cst:
      <span class="src-keyword">IF LAST-OF</span><!--src-keyword-->(w-qty) <span class="src-keyword">THEN DO</span><!--src-keyword-->:
        li = li + <span class="src-number">1</span><!--src-number-->.
        <span class="src-keyword">IF</span><!--src-keyword--> li <span class="src-keyword">LE EXTENT</span><!--src-keyword-->(<span class="src-prep">{&amp;TABLENAME}</span><!--src-prep-->.val) <span class="src-keyword">THEN DO</span><!--src-keyword-->:
          <span class="src-prep">{&amp;TABLENAME}</span><!--src-prep-->.val[li] = <span class="src-keyword">IF LAST</span><!--src-keyword-->(w-qty) <span class="src-keyword">THEN</span><!--src-keyword--> <span class="src-number">99999999</span><!--src-number--> <span class="src-keyword">ELSE</span><!--src-keyword--> w-qty.
          <span class="src-keyword">IF AVAIL</span><!--src-keyword--> b-ref <span class="src-keyword">THEN</span><!--src-keyword--> b-ref.val[li] = w-cst.
        <span class="src-keyword">END</span><!--src-keyword-->.
      <span class="src-keyword">END</span><!--src-keyword-->.
    <span class="src-keyword">END</span><!--src-keyword-->.
  <span class="src-keyword">END</span><!--src-keyword-->.
<span class="src-keyword">END</span><!--src-keyword-->.
 
<span class="src-keyword">ELSE</span><!--src-keyword-->
<span class="src-keyword">IF</span><!--src-keyword--> <span class="src-prep">{&amp;TABLENAME}</span><!--src-prep-->.reftable <span class="src-keyword">EQ</span><!--src-keyword--> <span class="src-char">"PLATE/FOUNTAIN"</span><!--src-char-->    <span class="src-keyword">OR</span><!--src-keyword-->
   <span class="src-prep">{&amp;TABLENAME}</span><!--src-prep-->.reftable <span class="src-keyword">EQ</span><!--src-keyword--> <span class="src-char">"cedepth"</span><!--src-char--> <span class="src-keyword">THEN RUN</span><!--src-keyword--> update-est (<span class="src-prep">{&amp;TABLENAME}</span><!--src-prep-->.loc).
 
<span class="src-keyword">ELSE</span><!--src-keyword-->
<span class="src-keyword">IF</span><!--src-keyword--> <span class="src-prep">{&amp;TABLENAME}</span><!--src-prep-->.reftable <span class="src-keyword">EQ</span><!--src-keyword--> <span class="src-char">"est/getqty.w"</span><!--src-char--> <span class="src-keyword">THEN RUN</span><!--src-keyword--> update-est (<span class="src-prep">{&amp;TABLENAME}</span><!--src-prep-->.<span class="src-keyword">code</span><!--src-keyword-->).
 
<span class="src-keyword">ELSE</span><!--src-keyword-->
<span class="src-keyword">IF</span><!--src-keyword--> <span class="src-prep">{&amp;TABLENAME}</span><!--src-prep-->.reftable <span class="src-keyword">EQ</span><!--src-keyword--> <span class="src-char">"POLSCORE"</span><!--src-char--> <span class="src-keyword">THEN DO</span><!--src-keyword-->:
  <span class="src-keyword">IF</span><!--src-keyword--> old-<span class="src-prep">{&amp;TABLENAME}</span><!--src-prep-->.reftable <span class="src-keyword">NE</span><!--src-keyword--> <span class="src-char">""</span><!--src-char--> <span class="src-keyword">THEN</span><!--src-keyword-->
  <span class="src-keyword">FOR EACH</span><!--src-keyword--> po-ordl
      <span class="src-keyword">WHERE</span><!--src-keyword--> po-ordl.company <span class="src-keyword">EQ</span><!--src-keyword--> reftable.company
       <span class="src-keyword">AND</span><!--src-keyword--> po-ordl.po-no    <span class="src-keyword">EQ INT</span><!--src-keyword-->(reftable.<span class="src-keyword">code</span><!--src-keyword-->)
       <span class="src-keyword">AND</span><!--src-keyword--> po-ordl.<span class="src-keyword">line     EQ INT</span><!--src-keyword-->(reftable.code2),
      <span class="src-keyword">FIRST</span><!--src-keyword--> po-ord
      <span class="src-keyword">WHERE</span><!--src-keyword--> po-ord.company <span class="src-keyword">EQ</span><!--src-keyword--> po-ordl.company
        <span class="src-keyword">AND</span><!--src-keyword--> po-ord.po-no   <span class="src-keyword">EQ</span><!--src-keyword--> po-ordl.po-no:
 
    <span class="src-keyword">IF</span><!--src-keyword--> po-ordl.stat <span class="src-keyword">NE</span><!--src-keyword--> <span class="src-char">"U"</span><!--src-char--> <span class="src-keyword">AND</span><!--src-keyword-->
       po-ordl.stat <span class="src-keyword">NE</span><!--src-keyword--> <span class="src-char">"C"</span><!--src-char--> <span class="src-keyword">AND</span><!--src-keyword-->
       po-ord.printed      <span class="src-keyword">AND</span><!--src-keyword-->
       po-ord.opened       <span class="src-keyword">THEN</span><!--src-keyword--> po-ordl.stat = <span class="src-char">"U"</span><!--src-char-->.
 
    <span class="src-keyword">IF</span><!--src-keyword--> po-ordl.stat <span class="src-keyword">EQ</span><!--src-keyword--> <span class="src-char">"U"</span><!--src-char--> <span class="src-keyword">AND</span><!--src-keyword-->
       po-ord.stat <span class="src-keyword">NE</span><!--src-keyword--> <span class="src-char">"H"</span><!--src-char-->  <span class="src-keyword">THEN</span><!--src-keyword--> po-ord.stat = <span class="src-char">"U"</span><!--src-char-->.
  <span class="src-keyword">END</span><!--src-keyword-->.
<span class="src-keyword">END</span><!--src-keyword-->.
 
<span class="src-comment">/* Clear out any error-status from find with no-error that is false */</span><!--src-comment-->
<span class="src-keyword">DEF VAR</span><!--src-keyword--> ll-error <span class="src-keyword">AS LOG NO-UNDO</span><!--src-keyword-->.
ll-error = <span class="src-keyword">YES NO-ERROR</span><!--src-keyword-->.
 
<span class="src-keyword">RETURN</span><!--src-keyword-->.
 
<span class="src-comment">/* Procedures */</span><!--src-comment-->
<span class="src-keyword">PROCEDURE</span><!--src-keyword--> update-est.
  <span class="src-keyword">DEF INPUT PARAM</span><!--src-keyword--> ip-est-no <span class="src-keyword">LIKE</span><!--src-keyword--> est.est-no <span class="src-keyword">NO-UNDO</span><!--src-keyword-->.
 
 
  <span class="src-keyword">FIND FIRST</span><!--src-keyword--> est
      <span class="src-keyword">WHERE</span><!--src-keyword--> est.company <span class="src-keyword">EQ</span><!--src-keyword--> <span class="src-prep">{&amp;TABLENAME}</span><!--src-prep-->.company
        <span class="src-keyword">AND</span><!--src-keyword--> est.est-no  <span class="src-keyword">EQ</span><!--src-keyword--> ip-est-no
      <span class="src-keyword">NO-ERROR</span><!--src-keyword-->.
 
  <span class="src-keyword">IF AVAIL</span><!--src-keyword--> est <span class="src-keyword">THEN DO</span><!--src-keyword-->:
    <span class="src-keyword">ASSIGN</span><!--src-keyword-->
     est.updated-date = <span class="src-keyword">TODAY</span><!--src-keyword-->
     est.updated-id   = <span class="src-keyword">USERID</span><!--src-keyword-->(<span class="src-char">"nosweat"</span><!--src-char-->)
     est.mod-date     = est.updated-date.
  <span class="src-keyword">END</span><!--src-keyword-->.
 
<span class="src-keyword">END PROCEDURE</span><!--src-keyword-->.
</div><!--progresscode-->
</body>
</html>
